import React, { useEffect, useMemo, useState, useRef, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Timer, Target, Shuffle, Flag, History, Trophy, Compass, X, ArrowLeft, Loader2, Calendar, Eye, EyeOff, PlayCircle, BookOpen, ArrowRight, CheckCircle2, ChevronRight, ChevronLeft, ChevronDown, ChevronUp, HelpCircle, Users, Share2 } from "lucide-react";
import confetti from "canvas-confetti";
import { ThemeSwitcher } from "@/components/ThemeSwitcher";
import { useTheme } from "@/contexts/ThemeContext";
import { supabase, LEADERBOARD_TABLE, DAILY_CHALLENGES_TABLE } from "@/lib/supabase";
import { getOrCreateUsername, getStoredUsername, setStoredUsername, hasSubmittedToday, markSubmittedToday, isUsernameAutoGenerated } from "@/lib/username";
import { trackGameStart, trackGameCompletion, updateUsernameAcrossTables } from "@/lib/gameAnalytics";
import { Leaderboard } from "@/components/Leaderboard";

// --- Utilities ---
const API = "https://en.wikipedia.org/w/api.php?origin=*";

// Daily Challenge utilities
function getDateString() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash);
}

function seededRandom(seed) {
  // Simple seeded random number generator (Linear Congruential Generator)
  let value = seed;
  return function() {
    value = (value * 9301 + 49297) % 233280;
    return value / 233280;
  };
}

function getDailyChallengeSeeds() {
  const dateStr = getDateString();
  const baseHash = hashString(dateStr);
  return {
    startSeed: baseHash,
    goalSeed: hashString(dateStr + '_goal'),
  };
}

function getTimeUntilMidnight() {
  const now = new Date();
  const midnight = new Date(now);
  midnight.setHours(24, 0, 0, 0);
  return midnight.getTime() - now.getTime();
}

// Predefined categories for dropdown
const CATEGORIES = [
  { value: "", label: "Any Category" },
  { value: "Physics", label: "Physics" },
  { value: "Mathematics", label: "Mathematics" },
  { value: "Biology", label: "Biology" },
  { value: "Chemistry", label: "Chemistry" },
  { value: "History", label: "History" },
  { value: "Geography", label: "Geography" },
  { value: "Literature", label: "Literature" },
  { value: "Music", label: "Music" },
  { value: "Film", label: "Film" },
  { value: "Sports", label: "Sports" },
  { value: "Technology", label: "Technology" },
  { value: "Philosophy", label: "Philosophy" },
  { value: "Art", label: "Art" },
  { value: "Medicine", label: "Medicine" },
  { value: "Astronomy", label: "Astronomy" },
];

// Special category mappings for categories that should fetch from multiple related categories
const CATEGORY_EXPANSIONS = {
};

async function fetchRandomTitle() {
  const url = `${API}&action=query&list=random&rnnamespace=0&rnlimit=1&format=json`;
  const res = await fetch(url);
  const data = await res.json();
  const title = data?.query?.random?.[0]?.title;
  return title || null;
}

async function fetchRandomTitleFromCategory(categoryName, seed = null) {
  if (!categoryName) return null;
  
  // Check if this category has expansions (multiple related categories)
  const categoriesToFetch = CATEGORY_EXPANSIONS[categoryName] || [categoryName];
  
  // Limit to first 7 categories for speed (or all if less than 7)
  const limitedCategories = categoriesToFetch.slice(0, 7);
  
  // Fetch articles from categories in parallel for speed
  const fetchPromises = limitedCategories.map(async (cat) => {
    const categoryUrl = `${API}&action=query&list=categorymembers&cmtitle=Category:${encodeURIComponent(cat)}&cmlimit=100&cmnamespace=0&format=json`;
    
    try {
      const res = await fetch(categoryUrl);
      const data = await res.json();
      const members = data?.query?.categorymembers || [];
      
      // Filter to only articles (not subcategories or files)
      const articles = members
        .filter(m => m.ns === 0) // ns=0 means main namespace (articles)
        .map(m => m.title);
      
      return articles;
    } catch (e) {
      console.error(`Error fetching articles from category ${cat}:`, e);
      return [];
    }
  });
  
  // Wait for all fetches to complete (in parallel)
  const results = await Promise.all(fetchPromises);
  
  // Flatten and remove duplicates
  let allArticles = [...new Set(results.flat())];
  
  // Sort articles for deterministic selection
  allArticles.sort();
  
  // Select one deterministically if seed provided, otherwise randomly
  if (allArticles.length === 0) return null;
  let randomIndex;
  if (seed !== null) {
    const rng = seededRandom(seed);
    randomIndex = Math.floor(rng() * allArticles.length);
  } else {
    randomIndex = Math.floor(Math.random() * allArticles.length);
  }
  return allArticles[randomIndex];
}

async function fetchDailyChallengeArticles() {
  const dateStr = getDateString();
  
  try {
    // Fetch daily challenge from Supabase
    const { data, error } = await supabase
      .from(DAILY_CHALLENGES_TABLE)
      .select('start_title, goal_title')
      .eq('date', dateStr)
      .single();
    
    if (error) {
      console.error('Error fetching daily challenge:', error);
      throw error;
    }
    
    if (!data || !data.start_title || !data.goal_title) {
      throw new Error('Daily challenge not found for today');
    }
    
    return {
      startTitle: data.start_title,
      goalTitle: data.goal_title,
    };
  } catch (err) {
    console.error('Failed to fetch daily challenge from Supabase:', err);
    // Fallback: return error so UI can handle it
    throw new Error('Failed to load daily challenge. Please try again later.');
  }
}

async function fetchLinks(title) {
  let allLinks = [];
  let continueToken = null;
  const MAX_LINKS = 1500;
  
  do {
    let url = `${API}&action=query&prop=links&plnamespace=0&pllimit=500&format=json&titles=${encodeURIComponent(title)}`;
    if (continueToken) {
      url += `&plcontinue=${encodeURIComponent(continueToken)}`;
    }
    
    const res = await fetch(url);
    const data = await res.json();
    const pages = data?.query?.pages || {};
    const firstPage = Object.values(pages)[0];
    const links = (firstPage?.links || []).map((l) => l.title);
    allLinks = allLinks.concat(links);
    
    // Stop if we've reached the limit
    if (allLinks.length >= MAX_LINKS) {
      allLinks = allLinks.slice(0, MAX_LINKS);
      break;
    }
    
    // Check if there are more results
    continueToken = data?.continue?.plcontinue || null;
  } while (continueToken);
  
  return allLinks;
}

async function fetchArticleHTML(title) {
  // Fetch mobile HTML version which is cleaner and easier to style
  const url = `https://en.wikipedia.org/api/rest_v1/page/html/${encodeURIComponent(title)}`;
  try {
    const res = await fetch(url);
    if (!res.ok) return null;
    const html = await res.text();
    return html;
  } catch (e) {
    console.error('Error fetching article HTML:', e);
    return null;
  }
}

async function fetchSummary(title) {
  const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  return {
    title: data.title,
    description: data.description,
    extract: data.extract,
    thumbnail: data.thumbnail?.source || null,
    url: data.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`,
  };
}

function prettyTime(ms) {
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return `${m}:${sec.toString().padStart(2, "0")}`;
}

function formatCountdown(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  if (hours > 0) {
    if (minutes > 0) {
      return `${hours}h ${minutes}m`;
    }
    return `${hours}h`;
  }
  if (minutes > 0) {
    return `${minutes}m ${seconds}s`;
  }
  return `${seconds}s`;
}

function useTimer(active) {
  const [start, setStart] = useState(null);
  const [now, setNow] = useState(null);
  useEffect(() => {
    let id;
    if (active) {
      const t0 = Date.now();
      setStart(t0);
      setNow(t0);
      id = setInterval(() => setNow(Date.now()), 250);
    }
    return () => id && clearInterval(id);
  }, [active]);
  return start && now ? now - start : 0;
}

// Wikipedia Article Viewer Component
function WikipediaArticleViewer({ html, onLinkClick, theme }) {
  const articleRef = useRef(null);
  const styleRef = useRef(null);

  useEffect(() => {
    if (!html || !articleRef.current) return;

    const container = articleRef.current;
    container.innerHTML = html;

    // Clean up DOM before styling
    const cleanupElements = () => {
      // Remove series boxes, navboxes, and similar templates
      const elementsToRemove = [
        '.navbox',
        '.vertical-navbox',
        '.horizontal-navbox',
        '.series-box',
        '.hatnote',
        '.dablink',
        '.rellink',
        '.infobox',
        '.sidebar',
        '.toc',
        '.tocnumber',
        '.mw-editsection',
        '.mw-indicators',
        '.reference',
        '.mw-references-wrap',
        '.reflist',
        '.mw-cite-backlink',
        '.noprint',
        '.mw-jump-link',
        '.mw-heading',
        'header',
        'nav',
        '.vector-header-container',
        '.vector-page-toolbar',
        '.vector-page-titlebar',
        '.vector-sticky-header',
        '.mw-search-container',
        '#searchform',
        '.cdx-search-input',
        '.vector-search-box',
        '#mw-head',
        '#mw-navigation',
        '.ambox',
        '.metadata',
        '.catlinks',
        '.mw-normal-catlinks',
        '.mw-hidden-catlinks',
        '.printfooter',
        '.mw-cite-backlink',
        '.mw-cite-up-arrow-backlink',
        '.mw-cite-bracket',
        '.mw-ref',
        '.mw-ref-reference',
        '[role="note"]',
        '.hatnote',
        '.dablink',
        '.rellink',
        '.vertical-navbox',
        '.horizontal-navbox',
        '.plainlinks',
        '.mw-parser-output > .mw-stack',
        '.mw-parser-output > .mw-stack-container',
        '.mw-parser-output > .mw-stack > .mw-stack',
        '.mw-parser-output > .mw-stack > .mw-stack-container',
      ];
      
      elementsToRemove.forEach(selector => {
        const elements = container.querySelectorAll(selector);
        elements.forEach(el => el.remove());
      });
      
      // Remove redirect notices (hatnotes) that appear at the top
      const hatnotes = container.querySelectorAll('.hatnote, .dablink, .rellink');
      hatnotes.forEach(el => el.remove());
      
      // Remove series navigation boxes and banners
      const seriesBoxes = container.querySelectorAll('[class*="series"], [class*="navbox"], [id*="series"], [id*="navbox"]');
      seriesBoxes.forEach(el => {
        const text = el.textContent.toLowerCase();
        if (text.includes('series') || text.includes('part of') || text.includes('navigation')) {
          el.remove();
        }
      });
      
      // Remove any divs or sections with blue backgrounds (often series banners) - simplified check
      const potentialBanners = container.querySelectorAll('div[style*="background"], section[style*="background"]');
      potentialBanners.forEach(el => {
        const styleAttr = el.getAttribute('style') || '';
        const text = el.textContent.toLowerCase();
        // Check for blue background colors in inline styles
        if ((styleAttr.includes('rgb(51, 102, 204)') || styleAttr.includes('#3366cc') || 
             styleAttr.includes('rgb(42, 75, 141)') || styleAttr.includes('background-color: #3366cc')) && 
            (text.includes('series') || text.includes('part of') || text.includes('article is part'))) {
          el.remove();
        }
      });
      
      // Remove citation needed markers but keep the text
      const citationNeeded = container.querySelectorAll('.citation-needed, .noprint');
      citationNeeded.forEach(el => el.remove());
      
      // Clean up empty paragraphs and divs
      const emptyElements = container.querySelectorAll('p:empty, div:empty');
      emptyElements.forEach(el => el.remove());
    };
    
    // Run initial cleanup after a small delay to ensure HTML is parsed
    setTimeout(() => {
      cleanupElements();
    }, 100);
    
    // Use MutationObserver to clean up dynamically added elements
    const observer = new MutationObserver(() => {
      // Debounce cleanup to avoid excessive calls
      clearTimeout(observer.timeout);
      observer.timeout = setTimeout(() => {
        cleanupElements();
      }, 50);
    });
    
    observer.observe(container, {
      childList: true,
      subtree: true
    });

    // Hide search bar and other Wikipedia UI elements
    const style = document.createElement('style');
    style.id = 'wikipedia-article-viewer-style';
    styleRef.current = style;
    style.textContent = `
      .wikipedia-article-viewer #mw-head,
      .wikipedia-article-viewer #mw-navigation,
      .wikipedia-article-viewer .mw-jump-link,
      .wikipedia-article-viewer .mw-editsection,
      .wikipedia-article-viewer .mw-indicators,
      .wikipedia-article-viewer .noprint,
      .wikipedia-article-viewer .navbox,
      .wikipedia-article-viewer .vertical-navbox,
      .wikipedia-article-viewer .horizontal-navbox,
      .wikipedia-article-viewer .infobox,
      .wikipedia-article-viewer .sidebar,
      .wikipedia-article-viewer .thumb,
      .wikipedia-article-viewer .toc,
      .wikipedia-article-viewer .mw-heading,
      .wikipedia-article-viewer header,
      .wikipedia-article-viewer nav,
      .wikipedia-article-viewer .vector-header-container,
      .wikipedia-article-viewer .vector-page-toolbar,
      .wikipedia-article-viewer .vector-page-titlebar,
      .wikipedia-article-viewer .vector-sticky-header,
      .wikipedia-article-viewer .mw-search-container,
      .wikipedia-article-viewer #searchform,
      .wikipedia-article-viewer .cdx-search-input,
      .wikipedia-article-viewer .vector-search-box,
      .wikipedia-article-viewer .hatnote,
      .wikipedia-article-viewer .dablink,
      .wikipedia-article-viewer .rellink,
      .wikipedia-article-viewer .ambox,
      .wikipedia-article-viewer .metadata,
      .wikipedia-article-viewer .catlinks,
      .wikipedia-article-viewer .mw-normal-catlinks,
      .wikipedia-article-viewer .mw-hidden-catlinks,
      .wikipedia-article-viewer .printfooter,
      .wikipedia-article-viewer .mw-cite-backlink,
      .wikipedia-article-viewer .mw-cite-up-arrow-backlink,
      .wikipedia-article-viewer .reference,
      .wikipedia-article-viewer .mw-references-wrap,
      .wikipedia-article-viewer .reflist,
      .wikipedia-article-viewer [role="note"],
      .wikipedia-article-viewer [class*="series-box"],
      .wikipedia-article-viewer [class*="navbox"] {
        display: none !important;
      }
      .wikipedia-article-viewer {
        ${theme === 'dark' 
          ? 'background: #1e293b; color: #e2e8f0;' 
          : theme === 'classic'
          ? 'background: #ffffff; color: #000000; border: 2px solid #000000;'
          : 'background: white; color: #1e293b;'}
        padding: 1rem;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      @media (min-width: 768px) {
        .wikipedia-article-viewer {
          padding: 1.5rem;
          max-height: calc(100vh - 200px);
        }
      }
      .wikipedia-article-viewer a {
        ${theme === 'dark'
          ? 'color: #60a5fa;'
          : theme === 'classic'
          ? 'color: #000000; text-decoration: underline;'
          : 'color: #2563eb;'}
        cursor: pointer;
        text-decoration: underline;
        touch-action: manipulation;
        min-height: 44px;
        display: inline-block;
        padding: 2px 0;
      }
      .wikipedia-article-viewer a:visited {
        ${theme === 'dark'
          ? 'color: #a78bfa;'
          : theme === 'classic'
          ? 'color: #000000;'
          : 'color: #7c3aed;'}
      }
      .wikipedia-article-viewer a:hover,
      .wikipedia-article-viewer a:active {
        ${theme === 'dark'
          ? 'color: #93c5fd;'
          : theme === 'classic'
          ? 'color: #ffffff; background-color: #000000;'
          : 'color: #3b82f6;'}
      }
      .wikipedia-article-viewer h1,
      .wikipedia-article-viewer h2,
      .wikipedia-article-viewer h3 {
        ${theme === 'dark' ? 'color: #f1f5f9;' : theme === 'classic' ? 'color: #000000; font-weight: bold;' : 'color: #0f172a;'}
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
      }
      @media (min-width: 768px) {
        .wikipedia-article-viewer h1,
        .wikipedia-article-viewer h2,
        .wikipedia-article-viewer h3 {
          margin-top: 1.5rem;
          margin-bottom: 0.75rem;
        }
        .wikipedia-article-viewer h1 {
          font-size: 1.875rem;
        }
        .wikipedia-article-viewer h2 {
          font-size: 1.5rem;
        }
        .wikipedia-article-viewer h3 {
          font-size: 1.25rem;
        }
      }
      .wikipedia-article-viewer p {
        margin-bottom: 0.875rem;
        line-height: 1.6;
        font-size: 0.9375rem;
      }
      @media (min-width: 768px) {
        .wikipedia-article-viewer p {
          margin-bottom: 1rem;
          font-size: 1rem;
        }
      }
      .wikipedia-article-viewer img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 0.5rem 0;
      }
      .wikipedia-article-viewer ul,
      .wikipedia-article-viewer ol {
        margin: 0.75rem 0;
        padding-left: 1.5rem;
        line-height: 1.6;
      }
      .wikipedia-article-viewer li {
        margin: 0.25rem 0;
      }
      .wikipedia-article-viewer blockquote {
        margin: 1rem 0;
        padding-left: 1rem;
        border-left: 3px solid ${theme === 'dark' ? '#475569' : theme === 'classic' ? '#000000' : '#cbd5e1'};
        ${theme === 'dark' ? 'color: #cbd5e1;' : theme === 'classic' ? 'color: #000000;' : 'color: #475569;'}
      }
      .wikipedia-article-viewer table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
      }
      .wikipedia-article-viewer table th,
      .wikipedia-article-viewer table td {
        padding: 0.5rem;
        border: 1px solid ${theme === 'dark' ? '#475569' : theme === 'classic' ? '#000000' : '#e2e8f0'};
      }
      .wikipedia-article-viewer table th {
        ${theme === 'dark' ? 'background: #334155;' : theme === 'classic' ? 'background: #f5f5f0;' : 'background: #f1f5f9;'}
        font-weight: 600;
      }
      .wikipedia-article-viewer .mw-parser-output > *:first-child {
        margin-top: 0;
      }
      .wikipedia-article-viewer .mw-parser-output > h1:first-child {
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid ${theme === 'dark' ? '#475569' : theme === 'classic' ? '#000000' : '#e2e8f0'};
      }
    `;
    
    // Remove existing style if present
    const existingStyle = document.getElementById('wikipedia-article-viewer-style');
    if (existingStyle) {
      existingStyle.remove();
    }
    
    document.head.appendChild(style);

    // Intercept all link clicks
    const links = container.querySelectorAll('a[href]');
    links.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const href = link.getAttribute('href');
        if (!href) return;

        // Extract article title from Wikipedia URL
        // Handle both /wiki/Article_Title and relative links
        let title = null;
        if (href.startsWith('/wiki/')) {
          title = decodeURIComponent(href.replace('/wiki/', ''));
        } else if (href.includes('wikipedia.org/wiki/')) {
          const match = href.match(/wiki\/([^?#]+)/);
          if (match) {
            title = decodeURIComponent(match[1]);
          }
        }

        // Only navigate if it's a valid article link (not external, not special pages)
        if (title && !title.startsWith('Special:') && !title.startsWith('File:') && !title.startsWith('Category:') && !title.startsWith('Template:') && !title.startsWith('Help:') && !title.startsWith('User:')) {
          // Replace underscores with spaces
          title = title.replace(/_/g, ' ');
          onLinkClick(title);
        }
      });
    });

    return () => {
      observer.disconnect();
      if (styleRef.current && styleRef.current.parentNode) {
        styleRef.current.parentNode.removeChild(styleRef.current);
      }
    };
  }, [html, onLinkClick, theme]);

  if (!html) {
    return (
      <div className={`flex items-center justify-center h-full p-4 md:p-8 ${
        theme === 'dark' ? 'text-gray-300' : 'text-slate-500'
      }`}>
        <div className="text-center">
          <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
          <p className="text-sm md:text-base">Loading article...</p>
        </div>
      </div>
    );
  }

  return (
    <div 
      ref={articleRef} 
      className="wikipedia-article-viewer"
      style={{ 
        maxHeight: 'calc(100vh - 180px)',
        overflowY: 'auto',
        WebkitOverflowScrolling: 'touch'
      }}
    />
  );
}

export default function WikipediaJourneyGame() {
  const { theme } = useTheme();
  
  // Setup
  const [startTitle, setStartTitle] = useState("");
  const [goalTitle, setGoalTitle] = useState("");
  const [startCategory, setStartCategory] = useState("");
  const [goalCategory, setGoalCategory] = useState("");
  const [startSummary, setStartSummary] = useState(null);
  const [goalSummary, setGoalSummary] = useState(null);
  const [currentTitle, setCurrentTitle] = useState(null);
  const [summary, setSummary] = useState(null);
  const [articleHTML, setArticleHTML] = useState(null);
  const [links, setLinks] = useState([]);
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [loadingStartRandom, setLoadingStartRandom] = useState(false);
  const [loadingGoalRandom, setLoadingGoalRandom] = useState(false);
  const [error, setError] = useState("");
  const [gameActive, setGameActive] = useState(false);
  const [won, setWon] = useState(false);
  const [dailyChallenge, setDailyChallenge] = useState(true); // Default to Daily Challenge
  const [timeUntilReset, setTimeUntilReset] = useState(getTimeUntilMidnight());
  const timer = useTimer(gameActive && !won);
  const dailyChallengeLoadedRef = useRef(false);
  const [searchQuery, setSearchQuery] = useState("");
  const [showArticleOnMobile, setShowArticleOnMobile] = useState(false);
  const [startingGame, setStartingGame] = useState(false);
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [onboardingStep, setOnboardingStep] = useState(0);
  const [showLeaderboard, setShowLeaderboard] = useState(false);
  const [showUsernameModal, setShowUsernameModal] = useState(false);
  const [username, setUsername] = useState("");
  const [usernameInput, setUsernameInput] = useState("");
  const [submittingScore, setSubmittingScore] = useState(false);
  const [leaderboardRefreshKey, setLeaderboardRefreshKey] = useState(0);
  const [scoreSubmitted, setScoreSubmitted] = useState(false);
  const [pendingSubmission, setPendingSubmission] = useState(false);
  
  // Challenge state
  const [challengeData, setChallengeData] = useState(null);
  const [showChallengeScreen, setShowChallengeScreen] = useState(false);
  const [isChallengeMode, setIsChallengeMode] = useState(false);
  const [showScoreBreakdown, setShowScoreBreakdown] = useState(false);

  // Progress heuristic: Jaccard similarity of words in titles (toy metric)
  const progress = useMemo(() => {
    if (!goalTitle || !currentTitle) return 0;
    const a = new Set(goalTitle.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean));
    const b = new Set(currentTitle.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean));
    const inter = [...a].filter((x) => b.has(x)).length;
    const union = new Set([...a, ...b]).size || 1;
    return Math.round((inter / union) * 100);
  }, [goalTitle, currentTitle]);

  async function loadPage(title, pushHistory = true) {
    try {
      setLoading(true);
      setError("");
      const [sum, lks, html] = await Promise.all([
        fetchSummary(title), 
        fetchLinks(title),
        fetchArticleHTML(title)
      ]);
      setSummary(sum);
      setLinks(lks);
      setArticleHTML(html);
      setCurrentTitle(sum?.title || title);
      if (pushHistory) setHistory((h) => [...h, sum?.title || title]);
    } catch (e) {
      setError("Couldn't load the page. Try another link.");
    } finally {
      setLoading(false);
    }
  }

  const handleLinkClick = useCallback((title) => {
    loadPage(title);
  }, []);

  // Filter links based on search query
  const filteredLinks = useMemo(() => {
    if (!searchQuery.trim()) return links;
    const query = searchQuery.toLowerCase();
    return links.filter(link => link.toLowerCase().includes(query));
  }, [links, searchQuery]);

  async function navigateToStep(stepIndex) {
    if (stepIndex < 0 || stepIndex >= history.length) return;
    const targetTitle = history[stepIndex];
    // Navigate to the clicked step as a new step (don't truncate history)
    await loadPage(targetTitle, true);
  }

  async function goBack() {
    if (history.length <= 1) return;
    const previousIndex = history.length - 2;
    const targetTitle = history[previousIndex];
    // Go back by truncating history and loading the previous page
    setHistory((h) => h.slice(0, previousIndex + 1));
    await loadPage(targetTitle, false);
  }

  async function startGame() {
    setStartingGame(true);
    setWon(false);
    setHistory([]);
    setSummary(null);
    setLinks([]);
    setError("");
    setGameActive(false);
    setShowArticleOnMobile(false);
    setShowChallengeScreen(false); // Hide challenge screen when starting game

    try {
      let s, g;
      
      // Check if we're in challenge mode
      if (isChallengeMode && challengeData) {
        // Use challenge articles
        s = challengeData.start;
        g = challengeData.end;
        setStartTitle(s);
        setGoalTitle(g);
        setStartCategory("");
        setGoalCategory("");
        setDailyChallenge(false); // Challenge mode overrides daily challenge
      } else if (dailyChallenge) {
        // Daily Challenge mode: use date-based deterministic selection
        const dailyArticles = await fetchDailyChallengeArticles();
        s = dailyArticles.startTitle;
        g = dailyArticles.goalTitle;
        setStartTitle(s);
        setGoalTitle(g);
        setStartCategory("");
        setGoalCategory("");
      } else {
        // Normal mode: use user selections or random
        s = startTitle;
      if (!s) {
        if (startCategory) {
          s = await fetchRandomTitleFromCategory(startCategory);
        } else {
          s = await fetchRandomTitle();
        }
      }
      
        g = goalTitle;
      if (!g) {
        if (goalCategory) {
          g = await fetchRandomTitleFromCategory(goalCategory);
        } else {
          g = await fetchRandomTitle();
        }
      }
      
      setStartTitle(s);
      setGoalTitle(g);
      }
      
      // Fetch goal summary immediately when starting with random titles
      if (g) {
        await fetchSummary(g).then(setGoalSummary).catch(() => setGoalSummary(null));
      }
      
      // Track game start
      if (s && g) {
        const sessionId = await trackGameStart({
          startTitle: s,
          goalTitle: g,
          isDailyChallenge: dailyChallenge && !isChallengeMode, // Don't track challenge as daily challenge
          startCategory: startCategory || null,
          goalCategory: goalCategory || null,
        });
        gameSessionId.current = sessionId;
      }
      
      setGameActive(true);
      await loadPage(s);
    } catch (e) {
      setError("Failed to start game. Try again.");
    } finally {
      setStartingGame(false);
    }
  }

  function resetGame() {
    setStartingGame(false);
    if (!dailyChallenge && !isChallengeMode) {
    setStartTitle("");
    setGoalTitle("");
    setStartCategory("");
    setGoalCategory("");
    }
    setStartSummary(null);
    setGoalSummary(null);
    setCurrentTitle(null);
    setSummary(null);
    setArticleHTML(null);
    setLinks([]);
    setHistory([]);
    setGameActive(false);
    setWon(false);
    setError("");
    setLoadingStartRandom(false);
    setLoadingGoalRandom(false);
    setShowArticleOnMobile(false);
    setScoreSubmitted(false);
    setPendingSubmission(false);
    setShowScoreBreakdown(false); // Reset score breakdown collapse state
    gameSessionId.current = null; // Reset game session ID
    // Clear challenge data and URL params on reset
    if (isChallengeMode) {
      setChallengeData(null);
      setIsChallengeMode(false);
      setShowChallengeScreen(false);
      // Clear URL parameters
      window.history.replaceState({}, '', window.location.pathname);
    }
    // Reset daily challenge loaded ref when resetting in daily challenge mode
    if (dailyChallenge) {
      dailyChallengeLoadedRef.current = false;
    }
  }

  // Switch to Random Game mode and generate new random articles
  async function switchToRandomGame() {
    // First reset the game state
    setStartingGame(false);
    setStartTitle("");
    setGoalTitle("");
    setStartCategory("");
    setGoalCategory("");
    setStartSummary(null);
    setGoalSummary(null);
    setCurrentTitle(null);
    setSummary(null);
    setArticleHTML(null);
    setLinks([]);
    setHistory([]);
    setGameActive(false);
    setWon(false);
    setError("");
    setLoadingStartRandom(false);
    setLoadingGoalRandom(false);
    setShowArticleOnMobile(false);
    setScoreSubmitted(false);
    setPendingSubmission(false);
    gameSessionId.current = null;
    dailyChallengeLoadedRef.current = false;
    
    // Switch to Random Game mode
    setDailyChallenge(false);
    
    // Generate new random articles
    setLoadingStartRandom(true);
    setLoadingGoalRandom(true);
    try {
      const newStartTitle = await fetchRandomTitle();
      const newGoalTitle = await fetchRandomTitle();
      
      if (newStartTitle) {
        setStartTitle(newStartTitle);
        // Fetch summary for start article
        fetchSummary(newStartTitle).then(setStartSummary).catch(() => setStartSummary(null));
      }
      
      if (newGoalTitle) {
        setGoalTitle(newGoalTitle);
        // Fetch summary for goal article
        fetchSummary(newGoalTitle).then(setGoalSummary).catch(() => setGoalSummary(null));
      }
    } catch (e) {
      setError("Failed to generate random articles. Please try again.");
    } finally {
      setLoadingStartRandom(false);
      setLoadingGoalRandom(false);
    }
  }
  
  // Check if onboarding has been shown before
  useEffect(() => {
    const hasSeenOnboarding = localStorage.getItem('wikiGo-onboarding-seen');
    // Show challenge screen first if challenge params exist, then onboarding if needed
    if (challengeData && !hasSeenOnboarding) {
      // Delay onboarding until after challenge screen is dismissed
      return;
    }
    if (!hasSeenOnboarding && !challengeData) {
      setShowOnboarding(true);
    }
  }, [challengeData]);

  // Initialize username on mount
  useEffect(() => {
    const storedUsername = getStoredUsername();
    if (storedUsername) {
      setUsername(storedUsername);
    } else {
      // Generate and store username on first visit
      const newUsername = getOrCreateUsername();
      setUsername(newUsername);
    }
  }, []);

  // Parse challenge URL parameters on mount
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const challengeStart = params.get('start');
    const challengeEnd = params.get('end');
    const challengeMoves = params.get('moves');
    const challengeTime = params.get('time');
    const challengeScore = params.get('score');
    const challengeUsername = params.get('username');

    // Validate all required challenge parameters exist
    if (challengeStart && challengeEnd && challengeMoves && challengeTime && challengeScore && challengeUsername) {
      const data = {
        start: decodeURIComponent(challengeStart),
        end: decodeURIComponent(challengeEnd),
        moves: parseInt(challengeMoves, 10),
        time: parseInt(challengeTime, 10), // time in seconds
        score: parseInt(challengeScore, 10),
        username: decodeURIComponent(challengeUsername),
      };

      // Validate numeric values
      if (!isNaN(data.moves) && !isNaN(data.time) && !isNaN(data.score) && data.moves >= 0 && data.time >= 0 && data.score >= 0) {
        setChallengeData(data);
        setIsChallengeMode(true);
      }
    }
  }, []); // Only run on mount

  // Show challenge screen when challenge data is available and game is not active
  useEffect(() => {
    if (challengeData && isChallengeMode && !gameActive && !won && !showChallengeScreen && !showOnboarding && !startingGame) {
      setShowChallengeScreen(true);
    }
  }, [challengeData, isChallengeMode, gameActive, won, showChallengeScreen, showOnboarding, startingGame]);

  // Update document title based on game state
  useEffect(() => {
    if (won) {
      document.title = `ðŸŽ‰ Challenge Complete! - WikiGo`;
    } else if (gameActive) {
      const currentPage = currentTitle || startTitle || 'Playing';
      document.title = `${currentPage} â†’ ${goalTitle || 'Goal'} - WikiGo`;
    } else if (dailyChallenge) {
      document.title = `Daily Challenge: ${startTitle || 'Loading...'} â†’ ${goalTitle || 'Loading...'} - WikiGo`;
    } else {
      document.title = 'WikiGo - Navigate Wikipedia Articles in the Fewest Moves';
    }
  }, [won, gameActive, dailyChallenge, currentTitle, startTitle, goalTitle]);

  // Show username modal when Daily Challenge is won and username is auto-generated
  useEffect(() => {
    if (won && dailyChallenge && isUsernameAutoGenerated()) {
      setShowUsernameModal(true);
      setPendingSubmission(true);
    }
  }, [won, dailyChallenge]);
  
  // Update time until reset for Daily Challenge
  useEffect(() => {
    if (!dailyChallenge) return;
    
    const interval = setInterval(() => {
      setTimeUntilReset(getTimeUntilMidnight());
    }, 1000);
    
    return () => clearInterval(interval);
  }, [dailyChallenge]);
  
  // Load daily challenge articles when mode is enabled
  useEffect(() => {
    if (dailyChallenge && !gameActive && !startTitle && !goalTitle && !dailyChallengeLoadedRef.current) {
      dailyChallengeLoadedRef.current = true;
      fetchDailyChallengeArticles().then(({ startTitle, goalTitle }) => {
        setStartTitle(startTitle);
        setGoalTitle(goalTitle);
      }).catch(() => {
        setError("Failed to load daily challenge. Try again.");
        dailyChallengeLoadedRef.current = false;
      });
    }
    
    // Reset the ref when daily challenge is disabled
    if (!dailyChallenge) {
      dailyChallengeLoadedRef.current = false;
    }
  }, [dailyChallenge, gameActive, startTitle, goalTitle]);

  useEffect(() => {
    if (currentTitle && goalTitle && gameActive) {
      // Normalize titles for comparison (case-insensitive, trim whitespace)
      const normalizedCurrent = currentTitle.trim().toLowerCase();
      const normalizedGoal = goalTitle.trim().toLowerCase();
      
      if (normalizedCurrent === normalizedGoal) {
        setWon(true);
        setGameActive(false);
      }
    }
  }, [currentTitle, goalTitle, gameActive]);

  // Fetch summaries for start and goal pages when titles change
  useEffect(() => {
    if (startTitle && !gameActive) {
      fetchSummary(startTitle).then(setStartSummary).catch(() => setStartSummary(null));
    } else if (!startTitle) {
      setStartSummary(null);
    }
  }, [startTitle, gameActive]);

  useEffect(() => {
    if (goalTitle) {
      // Fetch goal summary whenever goalTitle changes, regardless of gameActive state
      fetchSummary(goalTitle).then(setGoalSummary).catch(() => setGoalSummary(null));
    } else {
      setGoalSummary(null);
    }
  }, [goalTitle]);

  const moveCount = history.length ? history.length - 1 : 0;
  const finalTime = useRef(0);
  const confettiTriggered = useRef(false);
  const gameSessionId = useRef(null);

  // Calculate score: 1000 âˆ’ (10 Ã— moves) âˆ’ (1 Ã— seconds)
  const finalScore = useMemo(() => {
    if (!won) return 0;
    // Use finalTime.current if set, otherwise use current timer value
    const timeToUse = finalTime.current > 0 ? finalTime.current : timer;
    const seconds = Math.floor(timeToUse / 1000);
    return Math.max(0, 1000 - (10 * moveCount) - seconds);
  }, [won, moveCount, timer]);

  // Trigger confetti when game is won
  useEffect(() => {
    if (won && !confettiTriggered.current) {
      confettiTriggered.current = true;
      finalTime.current = timer;
      
      // Track game completion
      const timeToUse = finalTime.current;
      const score = finalScore;
      trackGameCompletion(gameSessionId.current, {
        score: score,
        moves: moveCount,
        timeMs: timeToUse,
        history: history,
      }).catch(err => {
        console.error('Failed to track game completion:', err);
      });
      
      // Confetti animation
      const duration = 3000;
      const animationEnd = Date.now() + duration;
      const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) {
          return clearInterval(interval);
        }

        const particleCount = 50 * (timeLeft / duration);
        confetti({
          ...defaults,
          particleCount,
          origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
        });
        confetti({
          ...defaults,
          particleCount,
          origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
        });
      }, 250);

      // Cleanup interval
      return () => {
        clearInterval(interval);
      };
    }
  }, [won, timer, finalScore, moveCount, history]);

  // Reset confetti trigger when game resets
  useEffect(() => {
    if (!won) {
      confettiTriggered.current = false;
      finalTime.current = 0;
    }
  }, [won]);

  // Submit score to leaderboard
  async function submitToLeaderboard() {
    if (!dailyChallenge || !won) return;
    
    const dateString = getDateString();
    
    // Check if already submitted today
    if (hasSubmittedToday(dateString)) {
      return;
    }

    const currentUsername = getStoredUsername() || getOrCreateUsername();
    const score = finalScore;
    const moves = moveCount;
    const timeMs = finalTime.current;

    try {
      setSubmittingScore(true);
      
      const { error } = await supabase
        .from(LEADERBOARD_TABLE)
        .insert([
          {
            username: currentUsername,
            score: score,
            moves: moves,
            time_ms: timeMs,
            date: dateString,
            start_title: startTitle,
            goal_title: goalTitle,
            history: history,
          },
        ]);

      if (error) {
        console.error('Error submitting score:', error);
        // Don't show error to user, just log it
      } else {
        // Mark as submitted
        markSubmittedToday(dateString);
        setScoreSubmitted(true);
        setPendingSubmission(false);
        // Refresh leaderboard if it's open
        setLeaderboardRefreshKey(prev => prev + 1);
      }
    } catch (err) {
      console.error('Error submitting to leaderboard:', err);
    } finally {
      setSubmittingScore(false);
    }
  }

  // Submit score when Daily Challenge is won (but wait if username needs confirmation)
  useEffect(() => {
    if (won && dailyChallenge && finalTime.current > 0 && !pendingSubmission && !scoreSubmitted) {
      submitToLeaderboard();
    }
  }, [won, dailyChallenge, finalScore, pendingSubmission, scoreSubmitted]);

  // --- UI ---
  return (
    <div className={`min-h-screen w-full p-2 sm:p-4 md:p-8 ${
      theme === 'dark' 
        ? 'bg-gray-950' 
        : theme === 'classic'
        ? 'bg-[#f5f5f0]'
        : 'bg-gradient-to-b from-slate-50 to-white'
    }`}>
      <div className="mx-auto max-w-[100%] sm:max-w-[95%] 2xl:max-w-[1600px] space-y-3 sm:space-y-4 lg:space-y-6">
        <header className="flex flex-col gap-2 sm:gap-3 md:flex-row md:items-end md:justify-between">
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2 flex-wrap">
              <h1 className={`text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight flex items-center gap-1.5 sm:gap-2 ${
                theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black font-serif' : 'text-slate-900'
              }`}>
                <Compass className="h-6 w-6 sm:h-7 sm:w-7 md:h-8 md:w-8" /> WikiGo
            </h1>
              {dailyChallenge && (
                <Badge variant="default" className="flex items-center gap-1 text-xs sm:text-sm">
                  <Calendar className="h-3 w-3" />
                  <span className="hidden xs:inline">Daily Challenge</span>
                  <span className="xs:hidden">Daily</span>
                </Badge>
              )}
          </div>
            {dailyChallenge && (
              <p className={`text-xs mt-1 sm:mt-2 flex items-center gap-1 ${
                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-500'
              }`}>
                <span>Challenge resets in:</span>
                <span className="font-semibold">{formatCountdown(timeUntilReset)}</span>
              </p>
            )}
          </div>
          <div className="flex gap-1.5 sm:gap-2 items-center flex-wrap">
            <Button
              variant="ghost"
              onClick={() => {
                setOnboardingStep(0);
                setShowOnboarding(true);
              }}
              className="h-9 sm:h-10 px-2 sm:px-4 text-xs sm:text-sm min-w-[44px] sm:min-w-0"
              title="Show instructions"
            >
              <span className="hidden sm:inline">Learn How To Play</span>
              <span className="sm:hidden">Learn</span>
            </Button>
            <Button
              variant="ghost"
              onClick={() => {
                setShowLeaderboard(true);
                setLeaderboardRefreshKey(prev => prev + 1);
              }}
              className="h-9 sm:h-10 px-2 sm:px-4 text-xs sm:text-sm min-w-[44px] sm:min-w-0"
              title="View leaderboard"
            >
              <Users className="h-4 w-4 sm:h-5 sm:w-5 mr-1.5 sm:mr-2" />
              <span className="hidden sm:inline">Leaderboard</span>
              <span className="sm:hidden">Board</span>
            </Button>
            <ThemeSwitcher />
            {!dailyChallenge && (
              <Button
                variant="outline"
                onClick={() => {
                  setDailyChallenge(true);
                  resetGame();
              }}
              className="flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm h-9 sm:h-10 px-2 sm:px-4 min-w-[44px] sm:min-w-0"
            >
              <Calendar className="h-3.5 w-3.5 sm:h-4 sm:w-4" />
              <span className="hidden sm:inline">Daily Challenge</span>
              <span className="sm:hidden">Daily</span>
            </Button>
            )}
            {!gameActive ? (
              <>
            <Button 
              variant="secondary" 
              onClick={resetGame}
                  disabled={startingGame}
              className="text-xs sm:text-sm h-9 sm:h-10 px-2 sm:px-4 min-w-[44px] sm:min-w-0"
            >
              Reset
            </Button>
            <Button 
              onClick={startGame}
                  disabled={startingGame || (dailyChallenge && hasSubmittedToday(getDateString()))}
              className={`text-xs sm:text-sm h-9 sm:h-10 px-3 sm:px-4 min-w-[44px] sm:min-w-0 ${
                dailyChallenge && !hasSubmittedToday(getDateString())
                  ? 'bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold'
                  : ''
              }`}
            >
                  {startingGame ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin mr-2" />
                      Starting...
                    </>
                  ) : dailyChallenge && hasSubmittedToday(getDateString()) ? (
                    "Already Completed"
                  ) : dailyChallenge ? (
                    <>
                      <PlayCircle className="h-4 w-4 mr-1.5" />
                      Start Challenge
                    </>
                  ) : (
                    <>
                      <Shuffle className="h-4 w-4 mr-1.5" />
                      Start Random Game
                    </>
                  )}
            </Button>
              </>
            ) : (
                <Button
                onClick={resetGame}
                disabled={startingGame}
                className="text-xs sm:text-sm h-9 sm:h-10 px-3 sm:px-4 min-w-[44px] sm:min-w-0"
              >
                {startingGame ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    Starting...
                  </>
                ) : (
                  "New Game"
                  )}
                </Button>
            )}
          </div>
        </header>

        {!gameActive && (
        <>
          {/* Daily Challenge - Central and Prominent */}
          {dailyChallenge && (
          <Card className={`shadow-lg border-2 ${
            theme === 'dark' 
              ? 'border-blue-600 bg-gradient-to-br from-blue-950/30 to-purple-950/30' 
              : theme === 'classic'
              ? 'border-blue-600 bg-blue-50'
              : 'border-blue-400 bg-gradient-to-br from-blue-50 to-purple-50'
          }`}>
            <CardHeader className={`p-3 sm:p-6 ${
              theme === 'dark' 
                ? 'bg-gradient-to-r from-blue-900/40 to-purple-900/40' 
                : theme === 'classic'
                ? 'bg-blue-100'
                : 'bg-gradient-to-r from-blue-100 to-purple-100'
            }`}>
              <div className="flex items-center justify-between flex-wrap gap-2">
                <CardTitle className={`text-base sm:text-lg flex items-center gap-2 ${
                  theme === 'dark' ? 'text-white' : 'text-blue-900'
                }`}>
                  <Calendar className={`h-5 w-5 ${
                    theme === 'dark' ? 'text-blue-300' : 'text-blue-600'
                  }`} />
                  Daily Challenge
                </CardTitle>
                <Badge variant="default" className="bg-blue-600 dark:bg-blue-500">
                  <Trophy className="h-3 w-3 mr-1" />
                  Compete Globally
                </Badge>
              </div>
            </CardHeader>
          <CardContent className="space-y-4 sm:space-y-6 p-3 sm:p-6">
            <div className="space-y-4">
              {/* Completion Status */}
              {(hasSubmittedToday(getDateString()) || won) ? (
                <>
                  <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-gradient-to-br from-green-900/30 to-emerald-900/30 border-green-600'
                      : theme === 'classic'
                      ? 'bg-green-50 border-green-600 border-4'
                      : 'bg-gradient-to-br from-green-50 to-emerald-50 border-green-400'
                  }`}>
                    <div className="flex items-center gap-2 sm:gap-3">
                      <CheckCircle2 className={`h-5 w-5 sm:h-6 sm:w-6 flex-shrink-0 ${
                        theme === 'dark' ? 'text-green-400' : 'text-green-600'
                      }`} />
                      <div className="flex-1">
                        <h3 className={`font-semibold text-sm sm:text-base mb-1 ${
                          theme === 'dark' ? 'text-green-200' : 'text-green-900'
                        }`}>
                          Challenge Completed! ðŸŽ‰
                        </h3>
                        <p className={`text-xs sm:text-sm ${
                          theme === 'dark' ? 'text-green-300' : 'text-green-800'
                        }`}>
                          You've already completed today's Daily Challenge. Check back tomorrow for a new challenge!
                        </p>
                      </div>
                    </div>
                    <Button
                      variant="outline"
                      onClick={() => {
                        setShowLeaderboard(true);
                        setLeaderboardRefreshKey(prev => prev + 1);
                      }}
                      className="w-full mt-3"
                    >
                      <Users className="h-4 w-4 mr-2" />
                      View Leaderboard
                    </Button>
                  </div>
                  
                  {/* New Random Game Promotion */}
                  <div className={`p-4 sm:p-6 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-gradient-to-br from-purple-900/30 to-blue-900/30 border-purple-600'
                      : theme === 'classic'
                      ? 'border-purple-600 bg-purple-50 border-4'
                      : 'bg-gradient-to-br from-purple-50 to-blue-50 border-purple-400'
                  }`}>
                    <div className="text-center space-y-3 sm:space-y-4">
                      <div className="flex justify-center">
                        <Shuffle className={`h-8 w-8 sm:h-10 sm:w-10 ${
                          theme === 'dark' ? 'text-purple-400' : 'text-purple-600'
                        }`} />
                      </div>
                      <h3 className={`font-semibold text-base sm:text-lg ${
                        theme === 'dark' ? 'text-purple-200' : 'text-purple-900'
                      }`}>
                        Try a New Random Game!
                      </h3>
                      <p className={`text-xs sm:text-sm ${
                        theme === 'dark' ? 'text-purple-300' : 'text-purple-800'
                      }`}>
                        Keep playing with unlimited random challenges. Each game features unique start and goal articles!
                      </p>
                      <Button
                        onClick={switchToRandomGame}
                        className={`w-full sm:w-auto ${
                          theme === 'dark'
                            ? 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white'
                            : 'bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white'
                        }`}
                      >
                        <Shuffle className="h-4 w-4 mr-2" />
                        Start New Random Game
                      </Button>
                    </div>
                  </div>
                </>
              ) : (
                <>
                  {/* Challenge Description */}
                  <div className={`p-3 sm:p-4 rounded-lg border ${
                    theme === 'dark'
                      ? 'border-gray-700 bg-gray-800/50'
                      : theme === 'classic'
                      ? 'border-blue-600 bg-blue-50'
                      : 'border-blue-200 bg-blue-50'
                  }`}>
                    <p className={`text-xs sm:text-sm mb-3 sm:mb-4 ${
                      theme === 'dark' ? 'text-gray-200' : 'text-slate-700'
                    }`}>
                      Today's challenge uses fixed start and goal articles that are the same for everyone. 
                      Try to complete it in as few moves as possible!
                    </p>
                      
                    {/* Start Article */}
                    {startTitle && (
                      <div className={`mb-3 sm:mb-4 p-3 sm:p-4 rounded-lg border ${
                        theme === 'dark'
                          ? 'border-gray-600 bg-gray-900/50'
                          : theme === 'classic'
                          ? 'border-black bg-white'
                          : 'border-slate-300 bg-white'
                      }`}>
                        <div className="flex items-start gap-3 sm:gap-4">
                          {startSummary?.thumbnail && (
                            <img 
                              src={startSummary.thumbnail} 
                              alt={startSummary.title} 
                              className="h-16 w-16 sm:h-20 sm:w-20 rounded-lg object-cover flex-shrink-0 border-2 ${
                                theme === 'dark' ? 'border-gray-600' : theme === 'classic' ? 'border-black' : 'border-slate-300'
                              }" 
                            />
                          )}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <Flag className={`h-4 w-4 sm:h-5 sm:w-5 ${
                                theme === 'dark' ? 'text-blue-400' : theme === 'classic' ? 'text-black' : 'text-blue-600'
                              }`} />
                              <span className={`text-xs font-medium ${
                                theme === 'dark' ? 'text-blue-300' : theme === 'classic' ? 'text-black' : 'text-blue-700'
                              }`}>
                                START ARTICLE
                              </span>
                            </div>
                            <h3 className={`font-bold text-base sm:text-lg mb-1 break-words ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              {startTitle}
                            </h3>
                            {startSummary?.description && (
                              <p className={`text-xs sm:text-sm mb-2 ${
                                theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                              }`}>
                                {startSummary.description}
                              </p>
                            )}
                            {startSummary?.extract && (
                              <p className={`text-xs line-clamp-2 ${
                                theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                              }`}>
                                {startSummary.extract}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Goal Article */}
                    {goalTitle && (
                      <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                        theme === 'dark'
                          ? 'border-yellow-600 bg-yellow-900/20'
                          : theme === 'classic'
                          ? 'border-black bg-yellow-50 border-4'
                          : 'border-yellow-400 bg-yellow-50'
                      }`}>
                        <div className="flex items-start gap-3 sm:gap-4">
                          {goalSummary?.thumbnail && (
                            <img 
                              src={goalSummary.thumbnail} 
                              alt={goalSummary.title} 
                              className="h-16 w-16 sm:h-20 sm:w-20 rounded-lg object-cover flex-shrink-0 border-2 ${
                                theme === 'dark' ? 'border-yellow-600' : theme === 'classic' ? 'border-black' : 'border-yellow-400'
                              }" 
                            />
                          )}
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1">
                              <Target className={`h-4 w-4 sm:h-5 sm:w-5 ${
                                theme === 'dark' ? 'text-yellow-400' : theme === 'classic' ? 'text-black' : 'text-yellow-600'
                              }`} />
                              <span className={`text-xs font-medium ${
                                theme === 'dark' ? 'text-yellow-300' : theme === 'classic' ? 'text-black' : 'text-yellow-700'
                              }`}>
                                GOAL ARTICLE
                              </span>
                            </div>
                            <h3 className={`font-bold text-base sm:text-lg mb-1 break-words ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              {goalTitle}
                            </h3>
                            {goalSummary?.description && (
                              <p className={`text-xs sm:text-sm mb-2 ${
                                theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                              }`}>
                                {goalSummary.description}
                              </p>
                            )}
                            {goalSummary?.extract && (
                              <p className={`text-xs line-clamp-2 ${
                                theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                              }`}>
                                {goalSummary.extract}
                              </p>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>
          </CardContent>
        </Card>
          )}

        {/* Random Game - Secondary Option */}
        {dailyChallenge && (
          <Card className="shadow-sm border border-dashed">
            <CardHeader className="p-3 sm:p-4">
              <CardTitle className="text-sm sm:text-base flex items-center gap-2">
                <Shuffle className="h-4 w-4" />
                Want to Play a Random Game Instead?
              </CardTitle>
            </CardHeader>
            <CardContent className="p-3 sm:p-4">
              <div className="space-y-3">
                <p className={`text-xs sm:text-sm ${
                  theme === 'dark' ? 'text-gray-400' : 'text-slate-600'
                }`}>
                  Play with custom start and goal articles of your choice. No leaderboard, just fun!
                </p>
                <Button
                  variant="outline"
                  onClick={switchToRandomGame}
                  className="w-full sm:w-auto"
                >
                  <Shuffle className="h-4 w-4 mr-2" />
                  Play Random Game
                </Button>
              </div>
            </CardContent>
          </Card>
        )}

        {/* Random Game Setup - Only shown when not Daily Challenge */}
        {!dailyChallenge && (
          <Card className="shadow-sm">
            <CardHeader className="p-3 sm:p-6">
              <CardTitle className="text-base sm:text-lg flex items-center gap-2">
                <Shuffle className="h-5 w-5" />
                Random Game Setup
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4 sm:space-y-6 p-3 sm:p-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
              <div className="space-y-2">
                <label className={`text-xs sm:text-sm ${
                  theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700 font-semibold' : 'text-slate-600'
                }`}>
                  Start article
                </label>
                <div className="space-y-2">
                  <select
                    value={startCategory}
                    onChange={(e) => setStartCategory(e.target.value)}
                    className={`flex h-10 sm:h-11 w-full rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-200 classic:ring-offset-white classic:focus-visible:ring-black classic:border-black classic:bg-white classic:text-black classic:border-2 ${
                      theme === 'dark'
                        ? "border-gray-800 bg-gray-900"
                        : theme === 'classic'
                        ? "border-slate-400 bg-white"
                        : "border-slate-200 bg-white"
                    }`}
                    disabled={gameActive || dailyChallenge}
                  >
                    {CATEGORIES.map((cat) => (
                      <option key={cat.value} value={cat.value}>
                        {cat.label}
                      </option>
                    ))}
                  </select>
                  <div className="flex gap-1.5 sm:gap-2">
                    <Input 
                      placeholder="e.g., Alan Turing" 
                      value={startTitle} 
                      onChange={(e) => setStartTitle(e.target.value)}
                      disabled={gameActive || dailyChallenge}
                      className="h-10 sm:h-11 text-sm flex-1 min-w-0"
                    />
                    <Button 
                      variant="outline" 
                      onClick={async () => {
                        if (loadingStartRandom || dailyChallenge) return; // Prevent multiple clicks
                        setError("");
                        setLoadingStartRandom(true);
                        try {
                          const title = startCategory 
                            ? await fetchRandomTitleFromCategory(startCategory)
                            : await fetchRandomTitle();
                          if (title) {
                            setStartTitle(title);
                          } else {
                            setError("Could not fetch random article. Try again or select a different category.");
                          }
                        } catch (e) {
                          setError("Failed to fetch random article. Please try again.");
                        } finally {
                          setLoadingStartRandom(false);
                        }
                      }}
                      disabled={gameActive || loadingStartRandom || dailyChallenge}
                      className="h-10 sm:h-11 min-w-[44px] sm:min-w-[48px] px-2 sm:px-3 flex-shrink-0"
                    >
                      {loadingStartRandom ? (
                        <Loader2 className="h-4 w-4 animate-spin" />
                      ) : (
                        <Shuffle className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                </div>
                {startSummary && !gameActive && (
                  <div className={`mt-3 p-3 rounded-lg border space-y-2 ${
                    theme === 'dark'
                      ? 'border-slate-700 bg-slate-800'
                      : theme === 'classic'
                      ? 'border-slate-400 bg-slate-50'
                      : 'border-slate-200 bg-slate-50'
                  }`}>
                    <div className="flex gap-3">
                      {startSummary.thumbnail && (
                        <img src={startSummary.thumbnail} alt={startSummary.title} className="h-16 w-16 rounded-lg object-cover flex-shrink-0" />
                      )}
                      <div className="flex-1 min-w-0">
                        <div className={`font-semibold text-sm ${
                          theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                        }`}>
                          {startSummary.title}
                        </div>
                        {startSummary.description && (
                          <div className={`text-xs mt-1 ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                          }`}>
                            {startSummary.description}
                          </div>
                        )}
                      </div>
                    </div>
                    {startSummary.extract && (
                      <p className={`text-xs line-clamp-3 ${
                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                      }`}>
                        {startSummary.extract}
                      </p>
                    )}
                  </div>
                )}
              </div>
              <div className="space-y-2">
                <label className={`text-xs sm:text-sm ${
                  theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700 font-semibold' : 'text-slate-600'
                }`}>
                  Goal article
                </label>
                <div className="space-y-2">
                  <select
                    value={goalCategory}
                    onChange={(e) => setGoalCategory(e.target.value)}
                    className={`flex h-10 sm:h-11 w-full rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-200 classic:ring-offset-white classic:focus-visible:ring-black classic:border-black classic:bg-white classic:text-black classic:border-2 ${
                      theme === 'dark'
                        ? "border-gray-800 bg-gray-900"
                        : theme === 'classic'
                        ? "border-slate-400 bg-white"
                        : "border-slate-200 bg-white"
                    }`}
                    disabled={gameActive || dailyChallenge}
                  >
                    {CATEGORIES.map((cat) => (
                      <option key={cat.value} value={cat.value}>
                        {cat.label}
                      </option>
                    ))}
                  </select>
                  <div className="flex gap-1.5 sm:gap-2">
                    <Input 
                      placeholder="e.g., Black Hole" 
                      value={goalTitle} 
                      onChange={(e) => setGoalTitle(e.target.value)}
                      disabled={gameActive || dailyChallenge}
                      className="h-10 sm:h-11 text-sm flex-1 min-w-0"
                    />
                    <Button 
                      variant="outline" 
                      onClick={async () => {
                        if (loadingGoalRandom || dailyChallenge) return; // Prevent multiple clicks
                        setError("");
                        setLoadingGoalRandom(true);
                        try {
                          const title = goalCategory 
                            ? await fetchRandomTitleFromCategory(goalCategory)
                            : await fetchRandomTitle();
                          if (title) {
                            setGoalTitle(title);
                          } else {
                            setError("Could not fetch random article. Try again or select a different category.");
                          }
                        } catch (e) {
                          setError("Failed to fetch random article. Please try again.");
                        } finally {
                          setLoadingGoalRandom(false);
                        }
                      }}
                      disabled={gameActive || loadingGoalRandom || dailyChallenge}
                      className="h-10 sm:h-11 min-w-[44px] sm:min-w-[48px] px-2 sm:px-3 flex-shrink-0"
                    >
                      {loadingGoalRandom ? (
                        <Loader2 className="h-4 w-4 animate-spin" />
                      ) : (
                        <Flag className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                </div>
                {goalSummary && !gameActive && (
                  <div className={`mt-3 p-3 rounded-lg border space-y-2 ${
                    theme === 'dark'
                      ? 'border-slate-700 bg-slate-800'
                      : theme === 'classic'
                      ? 'border-slate-400 bg-slate-50'
                      : 'border-slate-200 bg-slate-50'
                  }`}>
                    <div className="flex gap-3">
                      {goalSummary.thumbnail && (
                        <img src={goalSummary.thumbnail} alt={goalSummary.title} className="h-16 w-16 rounded-lg object-cover flex-shrink-0" />
                      )}
                      <div className="flex-1 min-w-0">
                        <div className={`font-semibold text-sm ${
                          theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                        }`}>
                          {goalSummary.title}
                        </div>
                        {goalSummary.description && (
                          <div className={`text-xs mt-1 ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                          }`}>
                            {goalSummary.description}
                          </div>
                        )}
                      </div>
                    </div>
                    {goalSummary.extract && (
                      <p className={`text-xs line-clamp-3 ${
                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                      }`}>
                        {goalSummary.extract}
                      </p>
                    )}
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
        )}
        </>
        )}

        {gameActive && articleHTML ? (
          <div className="flex flex-col lg:grid lg:grid-cols-[2fr,1.2fr,1.5fr] xl:grid-cols-[2.5fr,1.3fr,1.8fr] gap-3 sm:gap-4 lg:gap-4">
            {/* Left column: Full Wikipedia Article - Hidden on mobile by default */}
            <div className={`space-y-3 sm:space-y-4 lg:space-y-4 order-6 lg:order-1 ${showArticleOnMobile ? 'block' : 'hidden'} lg:block lg:min-w-0 lg:max-w-4xl xl:max-w-5xl`}>
              <Card className="shadow-sm lg:sticky lg:top-4">
                <CardHeader className="p-3 sm:p-4 lg:p-4">
                  <div className="flex items-center justify-between">
                    <CardTitle className="flex items-center gap-2 text-base sm:text-lg">
                      <Compass className="h-4 w-4 sm:h-5 sm:w-5" />
                      <span className="break-words">{summary?.title || currentTitle}</span>
                    </CardTitle>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => setShowArticleOnMobile(false)}
                      className="lg:hidden h-8 w-8 sm:h-9 sm:w-9 min-w-[32px] sm:min-w-[36px]"
                      title="Hide article"
                    >
                      <EyeOff className="h-4 w-4" />
                    </Button>
                  </div>
                </CardHeader>
                <CardContent className="p-0">
                  <WikipediaArticleViewer 
                    html={articleHTML} 
                    onLinkClick={handleLinkClick}
                    theme={theme}
                  />
                </CardContent>
              </Card>
            </div>

            {/* Toggle button to show article on mobile - Only visible when article is hidden */}
            {!showArticleOnMobile && (
              <div className="order-6 lg:hidden">
                <Button
                  variant="outline"
                  onClick={() => setShowArticleOnMobile(true)}
                  className="w-full h-10 sm:h-11 flex items-center justify-center gap-2"
                >
                  <Eye className="h-4 w-4" />
                  <span>Show Wikipedia Article</span>
                </Button>
              </div>
            )}

            {/* Middle column: Game Controls */}
          <div className="space-y-3 sm:space-y-4 lg:space-y-4 order-4 lg:order-2">
            <Card className="shadow-sm">
              <CardHeader className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0 p-3 sm:p-4 lg:p-4">
                <div className="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                  {gameActive && history.length > 1 && (
                    <Button
                      variant="outline"
                      size="icon"
                      onClick={goBack}
                      className="flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10 min-w-[36px] sm:min-w-[40px]"
                      title="Go back to previous page"
                    >
                      <ArrowLeft className="h-4 w-4" />
                    </Button>
                  )}
                    <CardTitle className="flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base flex-1 min-w-0">
                    <Target className="h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0" /> 
                    <span className="truncate">{goalTitle ? `Goal: ${goalTitle}` : "Pick a goal and start"}</span>
                  </CardTitle>
                </div>
                <div className="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
                  <Badge variant={won ? "default" : "secondary"} className="text-xs">
                    {won ? "Completed" : gameActive ? "In progress" : "Idle"}
                  </Badge>
                    <div className={`flex items-center gap-1 text-xs sm:text-sm ${
                      theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-600'
                    }`}>
                    <Timer className="h-3.5 w-3.5 sm:h-4 sm:w-4" /> {prettyTime(timer)}
                  </div>
                </div>
              </CardHeader>
              <CardContent className="p-3 sm:p-4 lg:p-4">
                {error && (
                    <div className={`mb-4 rounded-xl border p-3 text-sm ${
                      theme === 'dark'
                        ? 'border-red-800 bg-red-900/30 text-red-300'
                        : theme === 'classic'
                        ? 'border-red-600 bg-red-50 text-red-800'
                        : 'border-red-200 bg-red-50 text-red-700'
                    }`}>
                    {error}
                  </div>
                )}

                  {summary && (
                  <div className="space-y-3 sm:space-y-4">
                    <div className="flex gap-2 sm:gap-4">
                      {summary.thumbnail && (
                        <img src={summary.thumbnail} alt={summary.title} className="h-16 w-16 sm:h-20 sm:w-20 rounded-xl object-cover flex-shrink-0" />
                      )}
                      <div className="flex-1 min-w-0">
                          <div className={`text-lg sm:text-xl font-semibold break-words ${
                            theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                          }`}>
                            {summary.title}
                      </div>
                          <div className={`text-xs sm:text-sm ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                          }`}>
                            {summary.description}
                    </div>
                          <a className={`text-xs sm:text-sm underline touch-manipulation ${
                            theme === 'dark'
                              ? 'text-blue-400 hover:text-blue-300'
                              : theme === 'classic'
                              ? 'text-blue-600 visited:text-purple-600 hover:text-blue-800'
                              : 'text-blue-600 hover:text-blue-800'
                          }`} href={summary.url} target="_blank" rel="noreferrer">
                            Open on Wikipedia
                          </a>
                        </div>
                      </div>
                      <p className={`leading-relaxed text-xs sm:text-sm ${
                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                      }`}>
                        {summary.extract}
                      </p>
                    <div className="space-y-2">
                        <div className={`text-xs sm:text-sm font-semibold mb-2 ${
                          theme === 'dark' ? 'text-gray-100' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                        }`}>
                          Search links
                      </div>
                        <div className="flex gap-1.5 sm:gap-2">
                          <Input
                            type="text"
                            placeholder="Filter links..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className={`flex-1 h-9 sm:h-10 text-sm ${
                              theme === 'dark'
                                ? 'bg-slate-800 border-slate-700 text-white placeholder:text-slate-400'
                                : theme === 'classic'
                                ? 'bg-white border-slate-300 text-slate-900'
                                : 'bg-white border-slate-300 text-slate-900'
                            }`}
                          />
                          {searchQuery && (
                            <Button
                              variant="outline"
                              onClick={() => setSearchQuery("")}
                              className="flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10 min-w-[36px] sm:min-w-[40px] p-0"
                            >
                              <X className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                    </div>

                    <div className="mt-4 sm:mt-6">
                        <div className={`mb-2 text-xs sm:text-sm font-semibold flex items-center justify-between ${
                          theme === 'dark' ? 'text-gray-100' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                        }`}>
                          <span className="truncate">Available links {filteredLinks.length !== links.length && `(${filteredLinks.length}/${links.length})`}</span>
                        </div>
                        <div className="grid grid-cols-1 gap-1.5 sm:gap-2 max-h-[300px] sm:max-h-[400px] overflow-y-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                          {loading && (
                            <div className={`text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                            }`}>
                              Loading linksâ€¦
                            </div>
                          )}
                        {!loading && links.length === 0 && (
                            <div className={`text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                            }`}>
                              No links found on this page.
                            </div>
                          )}
                          {!loading && links.length > 0 && filteredLinks.length === 0 && (
                            <div className={`text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                            }`}>
                              No links match your search.
                            </div>
                        )}
                        {!loading &&
                            filteredLinks.map((l) => (
                              <Button 
                                key={l} 
                                variant="outline" 
                                className="justify-start text-left h-auto min-h-[44px] py-2 px-3 text-xs sm:text-sm break-words whitespace-normal" 
                                onClick={() => loadPage(l)}
                              >
                              {l}
                            </Button>
                          ))}
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

            {/* Right column: Goal Summary and Steps */}
          <div className="flex flex-col gap-3 sm:gap-4 lg:gap-4 order-1 lg:order-3">
            {/* Goal Summary - 1st on mobile */}
            {gameActive && goalSummary && (
                <Card className={`shadow-sm border-2 order-1 ${
                  theme === 'dark'
                    ? 'border-gray-700 bg-gray-800/50'
                    : theme === 'classic'
                    ? 'border-blue-600 bg-blue-50'
                    : 'border-blue-200 bg-blue-50/50'
                }`}>
                <CardHeader className="p-3 sm:p-4 lg:p-4">
                  <CardTitle className="flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base">
                      <Flag className={`h-4 w-4 sm:h-5 sm:w-5 ${
                        theme === 'dark' ? 'text-gray-300' : 'text-blue-600'
                      }`} />
                      <span className={theme === 'dark' ? 'text-gray-200' : 'text-blue-900'}>
                        Goal Article
                      </span>
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2 sm:space-y-3 p-3 sm:p-4 lg:p-4">
                  <div className="flex gap-2 sm:gap-3">
                    {goalSummary.thumbnail && (
                      <img src={goalSummary.thumbnail} alt={goalSummary.title} className="h-16 w-16 sm:h-20 sm:w-20 rounded-lg object-cover flex-shrink-0" />
                    )}
                    <div className="flex-1 min-w-0">
                        <div className={`font-semibold text-sm sm:text-base break-words ${
                          theme === 'dark' ? 'text-white' : 'text-slate-900'
                        }`}>
                          {goalSummary.title}
                        </div>
                      {goalSummary.description && (
                          <div className={`text-xs sm:text-sm mt-1 ${
                            theme === 'dark' ? 'text-gray-200' : 'text-slate-600'
                          }`}>
                            {goalSummary.description}
                          </div>
                      )}
                    </div>
                  </div>
                  {goalSummary.extract && (
                      <p className={`text-xs sm:text-sm leading-relaxed ${
                        theme === 'dark' ? 'text-gray-200' : 'text-slate-700'
                      }`}>
                        {goalSummary.extract}
                      </p>
                    )}
                    <a 
                      className={`text-xs sm:text-sm underline inline-block touch-manipulation ${
                        theme === 'dark'
                          ? 'text-blue-400 hover:text-blue-300'
                          : theme === 'classic'
                          ? 'text-blue-600 visited:text-purple-600 hover:text-blue-800'
                          : 'text-blue-600 hover:text-blue-800'
                      }`}
                    href={goalSummary.url} 
                    target="_blank" 
                    rel="noreferrer"
                  >
                    Open on Wikipedia â†’
                  </a>
                </CardContent>
              </Card>
            )}

            {/* Steps Taken - 2nd on mobile */}
            {gameActive && history.length > 0 && (
            <Card className="shadow-sm order-2">
                <CardHeader className="p-3 sm:p-4 lg:p-4">
                  <CardTitle className="flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base">
                    <History className="h-4 w-4 sm:h-5 sm:w-5" />
                    Steps Taken ({moveCount})
                  </CardTitle>
                </CardHeader>
                <CardContent className="p-3 sm:p-4 lg:p-4">
                  <div className="space-y-1.5 sm:space-y-2 max-h-[400px] sm:max-h-[500px] overflow-y-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                    {history.map((article, index) => (
                      <button
                        key={index}
                        onClick={() => navigateToStep(index)}
                          className={`w-full flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg transition-colors cursor-pointer text-left touch-manipulation min-h-[44px] ${
                            theme === 'dark'
                              ? 'bg-slate-800 hover:bg-slate-700 active:bg-slate-600'
                              : theme === 'classic'
                              ? 'bg-slate-100 hover:bg-blue-100 active:bg-blue-200 border border-slate-300'
                              : 'bg-slate-50 hover:bg-slate-200 active:bg-slate-300'
                          }`}
                        >
                          <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-semibold ${
                            theme === 'dark'
                              ? 'bg-slate-700 text-slate-200'
                              : theme === 'classic'
                              ? 'bg-slate-300 text-slate-900'
                              : 'bg-slate-200 text-slate-700'
                          }`}>
                          {index + 1}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className={`font-medium text-xs sm:text-sm break-words ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              {article}
                            </div>
                            {index === 0 && (
                              <div className={`text-xs mt-0.5 sm:mt-1 ${
                                theme === 'dark' ? 'text-gray-300' : 'text-slate-500'
                              }`}>
                                Start
                              </div>
                            )}
                            {index === history.length - 1 && (
                              <div className={`text-xs mt-0.5 sm:mt-1 font-semibold ${
                                theme === 'dark' ? 'text-green-400' : 'text-green-600'
                              }`}>
                                Current
                              </div>
                            )}
                        </div>
                        {index < history.length - 1 && (
                            <div className={`flex-shrink-0 ${theme === 'dark' ? 'text-gray-400' : 'text-slate-400'}`}>
                            <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                          </div>
                        )}
                      </button>
                    ))}
                  </div>
                </CardContent>
              </Card>
            )}
          </div>
        </div>
        ) : (
        <div className="grid md:grid-cols-[1.4fr,1fr] gap-3 sm:gap-4 lg:gap-6">
          <div className="space-y-3 sm:space-y-4 lg:space-y-6">
            {/* How to Play Card */}
            <Card className="shadow-sm">
              <CardHeader className="p-3 sm:p-4 lg:p-6">
                <CardTitle className="flex items-center gap-2 text-base sm:text-lg">
                  <PlayCircle className="h-5 w-5 sm:h-6 sm:w-6" />
                  How to Play
                </CardTitle>
              </CardHeader>
              <CardContent className={`space-y-4 sm:space-y-5 p-3 sm:p-4 lg:p-6 ${
                theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
              }`}>
                <div className="space-y-3 sm:space-y-4">
                  <div>
                    <h4 className={`font-semibold text-sm sm:text-base mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      Objective
                    </h4>
                    <p className="text-xs sm:text-sm leading-relaxed">
                      Navigate from a <strong>start article</strong> to a <strong>goal article</strong> using only the links found within Wikipedia articles. The goal is to reach your destination in the <strong>fewest moves</strong> and <strong>fastest time</strong> possible.
                    </p>
                  </div>

                  <div>
                    <h4 className={`font-semibold text-sm sm:text-base mb-2 mt-4 ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      Gameplay Steps
                    </h4>
                    <ol className="space-y-2 sm:space-y-3 text-xs sm:text-sm">
                      <li className="flex items-start gap-3">
                        <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-semibold text-xs ${
                          theme === 'dark'
                            ? 'bg-blue-600 text-white'
                            : theme === 'classic'
                            ? 'bg-black text-white border-2 border-black'
                            : 'bg-blue-100 text-blue-700'
                        }`}>1</span>
                        <span>Set your <strong>start article</strong> and <strong>goal article</strong> using the Setup section above, or click randomize</span>
                      </li>
                      <li className="flex items-start gap-3">
                        <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-semibold text-xs ${
                          theme === 'dark'
                            ? 'bg-blue-600 text-white'
                            : theme === 'classic'
                            ? 'bg-black text-white border-2 border-black'
                            : 'bg-blue-100 text-blue-700'
                        }`}>2</span>
                        <span>Click <strong>Start</strong> to begin your journey</span>
                      </li>
                      <li className="flex items-start gap-3">
                        <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-semibold text-xs ${
                          theme === 'dark'
                            ? 'bg-blue-600 text-white'
                            : theme === 'classic'
                            ? 'bg-black text-white border-2 border-black'
                            : 'bg-blue-100 text-blue-700'
                        }`}>3</span>
                        <span>Read the current article and click on any <strong>blue link</strong> to navigate to the next article</span>
                      </li>
                      <li className="flex items-start gap-3">
                        <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-semibold text-xs ${
                          theme === 'dark'
                            ? 'bg-blue-600 text-white'
                            : theme === 'classic'
                            ? 'bg-black text-white border-2 border-black'
                            : 'bg-blue-100 text-blue-700'
                        }`}>4</span>
                        <span>Use the <strong>Available Links</strong> panel or search to find links quickly</span>
                      </li>
                      <li className="flex items-start gap-3">
                        <span className={`flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center font-semibold text-xs ${
                          theme === 'dark'
                            ? 'bg-green-600 text-white'
                            : theme === 'classic'
                            ? 'bg-black text-white border-2 border-black'
                            : 'bg-green-100 text-green-700'
                        }`}>5</span>
                        <span>Reach the goal article to win! Your score is based on moves and time</span>
                      </li>
                    </ol>
                  </div>

                  <div className={`mt-4 sm:mt-5 p-3 sm:p-4 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-gradient-to-br from-purple-900/30 to-blue-900/30 border-purple-700/50'
                      : theme === 'classic'
                      ? 'bg-white border-black'
                      : 'bg-gradient-to-br from-purple-50/50 to-blue-50/50 border-purple-200'
                  }`}>
                    <div className="flex items-center gap-2 mb-3">
                      <BookOpen className={`h-4 w-4 sm:h-5 sm:w-5 ${
                        theme === 'dark' ? 'text-purple-300' : theme === 'classic' ? 'text-black' : 'text-purple-600'
                      }`} />
                      <h4 className={`font-semibold text-sm sm:text-base ${
                        theme === 'dark' ? 'text-purple-200' : theme === 'classic' ? 'text-black' : 'text-purple-900'
                      }`}>
                        Example Journey
                      </h4>
                    </div>
                    <div className="space-y-2 sm:space-y-3">
                      <p className="text-xs sm:text-sm mb-3">
                        Here's an example of how you might navigate from one article to another:
                      </p>
                      
                      {/* Example Journey Steps */}
                      <div className="space-y-2 sm:space-y-2.5">
                        <div className={`flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 rounded-lg border-2 ${
                          theme === 'dark'
                            ? 'bg-slate-800/50 border border-slate-700'
                            : theme === 'classic'
                            ? 'bg-white border-black'
                            : 'bg-white border border-slate-200'
                        }`}>
                          <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm border-2 ${
                            theme === 'dark'
                              ? 'bg-blue-600 text-white'
                              : theme === 'classic'
                              ? 'bg-black text-white border-black'
                              : 'bg-blue-100 text-blue-700'
                          }`}>
                            1
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              Start: <span className="font-semibold">Alan Turing</span>
                            </div>
                            <div className={`text-xs mt-0.5 ${
                              theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                            }`}>
                              Mathematician and computer scientist
                            </div>
                          </div>
                        </div>

                        <div className="flex justify-center">
                          <ArrowRight className={`h-4 w-4 sm:h-5 sm:w-5 ${
                            theme === 'dark' ? 'text-gray-500' : 'text-slate-400'
                          }`} />
                        </div>

                        <div className={`flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 rounded-lg border-2 ${
                          theme === 'dark'
                            ? 'bg-slate-800/50 border border-slate-700'
                            : theme === 'classic'
                            ? 'bg-white border-black'
                            : 'bg-white border border-slate-200'
                        }`}>
                          <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm border-2 ${
                            theme === 'dark'
                              ? 'bg-blue-600 text-white'
                              : theme === 'classic'
                              ? 'bg-black text-white border-black'
                              : 'bg-blue-100 text-blue-700'
                          }`}>
                            2
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              Click link: <span className="font-semibold">Computer Science</span>
                            </div>
                            <div className={`text-xs mt-0.5 ${
                              theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                            }`}>
                              Found in Alan Turing article
                            </div>
                          </div>
                        </div>

                        <div className="flex justify-center">
                          <ArrowRight className={`h-4 w-4 sm:h-5 sm:w-5 ${
                            theme === 'dark' ? 'text-gray-500' : 'text-slate-400'
                          }`} />
                        </div>

                        <div className={`flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 rounded-lg border-2 ${
                          theme === 'dark'
                            ? 'bg-slate-800/50 border border-slate-700'
                            : theme === 'classic'
                            ? 'bg-white border-black'
                            : 'bg-white border border-slate-200'
                        }`}>
                          <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm ${
                            theme === 'dark'
                              ? 'bg-blue-600 text-white'
                              : theme === 'classic'
                              ? 'bg-black text-white border-black'
                              : 'bg-blue-100 text-blue-700'
                          }`}>
                            3
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              Click link: <span className="font-semibold">Artificial Intelligence</span>
                            </div>
                            <div className={`text-xs mt-0.5 ${
                              theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                            }`}>
                              Found in Computer Science article
                            </div>
                          </div>
                        </div>

                        <div className="flex justify-center">
                          <ArrowRight className={`h-4 w-4 sm:h-5 sm:w-5 ${
                            theme === 'dark' ? 'text-gray-500' : 'text-slate-400'
                          }`} />
                        </div>

                        <div className={`flex items-center gap-2 sm:gap-3 p-2 sm:p-2.5 rounded-lg border-2 ${
                          theme === 'dark'
                            ? 'bg-green-900/20 border-green-600'
                            : theme === 'classic'
                            ? 'bg-white border-black border-4'
                            : 'bg-green-50 border-green-300'
                        }`}>
                          <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm border-2 ${
                            theme === 'dark'
                              ? 'bg-green-600 text-white'
                              : theme === 'classic'
                              ? 'bg-black text-white border-black'
                              : 'bg-green-100 text-green-700'
                          }`}>
                            <CheckCircle2 className={`h-4 w-4 sm:h-5 sm:w-5 ${theme === 'classic' ? 'text-white' : ''}`} />
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium text-xs sm:text-sm ${
                              theme === 'dark' ? 'text-green-200' : theme === 'classic' ? 'text-black' : 'text-green-900'
                            }`}>
                              Goal: <span className="font-semibold">Machine Learning</span>
                            </div>
                            <div className={`text-xs mt-0.5 ${
                              theme === 'dark' ? 'text-green-300' : theme === 'classic' ? 'text-black' : 'text-green-700'
                            }`}>
                              Found in Artificial Intelligence article âœ“
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className={`mt-3 pt-3 border-t ${
                        theme === 'dark' ? 'border-slate-700' : 'border-slate-200'
                      }`}>
                        <p className={`text-xs sm:text-sm italic ${
                          theme === 'dark' ? 'text-gray-400' : 'text-slate-600'
                        }`}>
                          <strong>Tip:</strong> In this example, we used 3 moves. Try to find even shorter paths by thinking about how articles connect!
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Game Status Card - Only show when there's content or game is active */}
            {(summary || error || gameActive) && (
            <Card className="shadow-sm">
              <CardHeader className="flex flex-row items-center justify-between">
                <div className="flex items-center gap-3">
                  {gameActive && history.length > 1 && (
                    <Button
                      variant="outline"
                      size="icon"
                      onClick={goBack}
                      className="flex-shrink-0"
                      title="Go back to previous page"
                    >
                      <ArrowLeft className="h-4 w-4" />
                    </Button>
                  )}
                  <CardTitle className="flex items-center gap-2">
                    <Target className="h-5 w-5" /> {goalTitle ? `Goal: ${goalTitle}` : "Pick a goal and start"}
                  </CardTitle>
                </div>
                <div className="flex items-center gap-3">
                  <Badge variant={won ? "default" : "secondary"} className="text-xs">
                    {won ? "Completed" : gameActive ? "In progress" : "Idle"}
                  </Badge>
                  <div className={`flex items-center gap-1 text-sm ${
                    theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-600'
                  }`}>
                    <Timer className="h-4 w-4" /> {prettyTime(timer)}
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                {error && (
                  <div className={`mb-4 rounded-xl border p-3 text-sm ${
                    theme === 'dark'
                      ? 'border-red-800 bg-red-900/30 text-red-300'
                      : theme === 'classic'
                      ? 'border-red-600 bg-red-50 text-red-800'
                      : 'border-red-200 bg-red-50 text-red-700'
                  }`}>
                    {error}
                  </div>
                )}

                {summary ? (
                  <div className="space-y-4">
                    <div className="flex gap-4">
                      {summary.thumbnail && (
                        <img src={summary.thumbnail} alt={summary.title} className="h-20 w-20 rounded-xl object-cover" />
                      )}
                      <div>
                        <div className={`text-xl font-semibold ${
                          theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                        }`}>
                          {summary.title}
                        </div>
                        <div className={`text-sm ${
                          theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                        }`}>
                          {summary.description}
                        </div>
                        <a className={`text-sm underline ${
                          theme === 'dark'
                            ? 'text-blue-400 hover:text-blue-300'
                            : theme === 'classic'
                            ? 'text-blue-600 visited:text-purple-600 hover:text-blue-800'
                            : 'text-blue-600 hover:text-blue-800'
                        }`} href={summary.url} target="_blank" rel="noreferrer">
                          Open on Wikipedia
                        </a>
                      </div>
                    </div>
                    <p className={`leading-relaxed ${
                      theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                    }`}>
                      {summary.extract}
                    </p>
                    <div className="space-y-2">
                      <div className={`text-sm font-semibold mb-2 ${
                        theme === 'dark' ? 'text-gray-100' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                      }`}>
                        Search links
                      </div>
                      <div className="flex gap-2">
                        <Input
                          type="text"
                          placeholder="Filter available links..."
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          className={`flex-1 ${
                            theme === 'dark'
                              ? 'bg-slate-800 border-slate-700 text-white placeholder:text-slate-400'
                              : theme === 'classic'
                              ? 'bg-white border-slate-300 text-slate-900'
                              : 'bg-white border-slate-300 text-slate-900'
                          }`}
                        />
                        {searchQuery && (
                          <Button
                            variant="outline"
                            onClick={() => setSearchQuery("")}
                            className="flex-shrink-0"
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        )}
                      </div>
                    </div>

                    <div className="mt-6">
                      <div className={`mb-2 text-sm font-semibold flex items-center justify-between ${
                        theme === 'dark' ? 'text-gray-100' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                      }`}>
                        <span>Available links {filteredLinks.length !== links.length && `(${filteredLinks.length} of ${links.length})`}</span>
                      </div>
                      <div className="grid grid-cols-1 gap-2 max-h-[400px] overflow-y-auto">
                        {loading && (
                          <div className={`text-sm ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                          }`}>
                            Loading linksâ€¦
                          </div>
                        )}
                        {!loading && links.length === 0 && (
                          <div className={`text-sm ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                          }`}>
                            No links found on this page.
                          </div>
                        )}
                        {!loading && links.length > 0 && filteredLinks.length === 0 && (
                          <div className={`text-sm ${
                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                          }`}>
                            No links match your search.
                          </div>
                        )}
                        {!loading &&
                          filteredLinks.map((l) => (
                            <Button key={l} variant="outline" className="justify-start text-left" onClick={() => loadPage(l)}>
                              {l}
                            </Button>
                          ))}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className={`text-sm ${
                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                  }`}>
                    Click <span className="font-medium">Start</span> to randomize (or use your own) start/goal and begin the journey.
                  </div>
                )}
              </CardContent>
            </Card>
            )}
          </div>
          
          {/* Right column: Scoring Instructions */}
          <div className="space-y-3 sm:space-y-4 lg:space-y-6">
            <Card className="shadow-sm">
              <CardHeader className="p-3 sm:p-4 lg:p-6">
                <CardTitle className="flex items-center gap-2 text-base sm:text-lg">
                  <Trophy className={`h-5 w-5 sm:h-6 sm:w-6 ${theme === 'classic' ? 'text-black' : ''}`} />
                  Scoring Methodology
                </CardTitle>
              </CardHeader>
              <CardContent className={`space-y-3 sm:space-y-4 p-3 sm:p-4 lg:p-6 ${
                theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
              }`}>
                <div className="space-y-2 sm:space-y-3">
                  <div>
                    <h4 className={`font-semibold text-sm sm:text-base mb-1.5 sm:mb-2 ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      How Scoring Works
                    </h4>
                    <p className="text-xs sm:text-sm leading-relaxed">
                      Your score is calculated using a simple formula that rewards efficiency:
                    </p>
                  </div>
                  
                  <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-slate-800/50 border-slate-700'
                      : theme === 'classic'
                      ? 'bg-white border-black'
                      : 'bg-blue-50/50 border-blue-200'
                  }`}>
                    <div className={`font-mono text-sm sm:text-base font-semibold mb-2 ${
                      theme === 'dark' ? 'text-blue-300' : theme === 'classic' ? 'text-black' : 'text-blue-700'
                    }`}>
                      Score = 1000 âˆ’ (10 Ã— moves) âˆ’ (1 Ã— seconds)
                    </div>
                    <div className="space-y-1.5 text-xs sm:text-sm">
                      <div className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span><strong>Base Score:</strong> Start with 1000 points</span>
                      </div>
                      <div className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span><strong>Move Penalty:</strong> Lose 10 points per move</span>
                      </div>
                      <div className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span><strong>Time Penalty:</strong> Lose 1 point per second</span>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 className={`font-semibold text-sm sm:text-base mb-1.5 sm:mb-2 mt-3 sm:mt-4 ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      Tips for Higher Scores
                    </h4>
                    <ul className="space-y-1.5 sm:space-y-2 text-xs sm:text-sm">
                      <li className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span>Use link structure intuitionâ€”jump to broad categories, then narrow in</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span>Fewer moves = higher score. Plan your path before clicking</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span>Faster completion = higher score. Time matters!</span>
                      </li>
                      <li className="flex items-start gap-2">
                        <span className="font-semibold">â€¢</span>
                        <span>Beat your personal best by optimizing both moves and time</span>
                      </li>
                    </ul>
                  </div>
                  
                  <div className={`mt-3 sm:mt-4 p-2 sm:p-3 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-yellow-900/20 border border-yellow-800/50'
                      : theme === 'classic'
                      ? 'bg-white border-black'
                      : 'bg-yellow-50/50 border border-yellow-200'
                  }`}>
                    <p className="text-xs sm:text-sm italic">
                      <strong>Note:</strong> Minimum score is 0. Scores cannot go negative.
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
        )}

        <footer className={`text-xs text-center pt-4 ${
          theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
        }`}>
          Uses the public Wikipedia API. Be kind to Wikimedia servers.
        </footer>
      </div>

      {/* Victory Summary Screen */}
      {won && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-0 sm:p-2 md:p-4 safe-area-inset">
          <div className="w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-2xl flex flex-col sm:rounded-lg shadow-2xl overflow-hidden">
            <Card className="flex flex-col h-full sm:h-auto overflow-hidden">
              <CardHeader className="relative bg-gradient-to-r from-yellow-400 via-orange-400 to-pink-400 text-white p-3 sm:p-4 md:p-6 flex-shrink-0">
                <div className="flex items-center justify-center gap-1.5 sm:gap-2 md:gap-3">
                  <Trophy className="h-4 w-4 sm:h-5 sm:w-5 md:h-6 md:w-6 lg:h-8 lg:w-8" />
                  <CardTitle className="text-lg sm:text-xl md:text-2xl lg:text-3xl">
                    {isChallengeMode ? "Challenge Complete!" : "Congratulations!"}
                  </CardTitle>
                </div>
                <p className="text-center mt-1 text-yellow-50 text-[11px] sm:text-xs md:text-sm lg:text-base">
                  {isChallengeMode 
                    ? "You've completed the challenge!" 
                    : "You've reached your destination!"}
                </p>
                <Button
                  variant="ghost"
                  size="icon"
                  className="absolute top-1.5 right-1.5 sm:top-2 sm:right-2 md:top-4 md:right-4 text-white hover:bg-white/20 h-7 w-7 sm:h-8 sm:w-8 md:h-10 md:w-10 min-w-[44px] min-h-[44px]"
                  onClick={resetGame}
                >
                  <X className="h-3.5 w-3.5 sm:h-4 sm:w-4 md:h-5 md:w-5" />
                </Button>
              </CardHeader>
              <CardContent className="flex-1 overflow-y-auto p-2.5 sm:p-3 md:p-4 lg:p-6 space-y-2.5 sm:space-y-3 md:space-y-4 lg:space-y-6 pb-safe">
              {/* Stats Grid */}
              <div className="grid grid-cols-3 gap-1 sm:gap-1.5 md:gap-2 lg:gap-3 xl:gap-4">
                <div className={`text-center p-1 sm:p-1.5 md:p-2 lg:p-3 xl:p-4 rounded-lg ${
                  theme === 'dark' ? 'bg-gray-800' : theme === 'classic' ? 'bg-slate-100 border border-slate-300' : 'bg-slate-50'
                }`}>
                  <div className={`text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl font-bold ${
                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                  }`}>
                    {moveCount}
                </div>
                  <div className={`text-[9px] sm:text-[10px] md:text-xs lg:text-sm mt-0.5 ${
                    theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                  }`}>
                    Moves
                </div>
                </div>
                <div className={`text-center p-1 sm:p-1.5 md:p-2 lg:p-3 xl:p-4 rounded-lg ${
                  theme === 'dark' ? 'bg-gray-800' : theme === 'classic' ? 'bg-slate-100 border border-slate-300' : 'bg-slate-50'
                }`}>
                  <div className={`text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl font-bold ${
                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                  }`}>
                    {prettyTime(finalTime.current)}
                  </div>
                  <div className={`text-[9px] sm:text-[10px] md:text-xs lg:text-sm mt-0.5 ${
                    theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                  }`}>
                    Time
                  </div>
                </div>
                <div className={`text-center p-1 sm:p-1.5 md:p-2 lg:p-3 xl:p-4 rounded-lg border-2 ${
                  theme === 'dark'
                    ? 'bg-gradient-to-br from-yellow-900/50 to-orange-900/50 border-yellow-600'
                    : theme === 'classic'
                    ? 'bg-gradient-to-br from-yellow-100 to-orange-100 border-yellow-500'
                    : 'bg-gradient-to-br from-yellow-100 to-orange-100 border-yellow-300'
                }`}>
                  <div className={`text-base sm:text-lg md:text-xl lg:text-2xl xl:text-3xl font-bold ${
                    theme === 'dark' ? 'text-yellow-200' : 'text-slate-900'
                  }`}>
                    {finalScore}
                  </div>
                  <div className={`text-[9px] sm:text-[10px] md:text-xs lg:text-sm mt-0.5 ${
                    theme === 'dark' ? 'text-yellow-300' : 'text-slate-600'
                  }`}>
                    Score
                  </div>
                </div>
              </div>

              {/* Primary CTA: Challenge Button */}
              <div className="space-y-1 sm:space-y-1.5 md:space-y-2 lg:space-y-3">
                <Button
                  onClick={() => {
                    // Generate challenge URL with all game data
                    const baseUrl = window.location.origin + window.location.pathname;
                    const challengeUrl = `${baseUrl}?start=${encodeURIComponent(startTitle)}&end=${encodeURIComponent(goalTitle)}&moves=${moveCount}&time=${Math.floor(finalTime.current / 1000)}&score=${finalScore}&username=${encodeURIComponent(username)}`;
                    
                    const shareText = `${username} challenged you to beat their WikiGo score! Can you navigate from "${startTitle}" to "${goalTitle}" faster? Score: ${finalScore} in ${moveCount} moves and ${prettyTime(finalTime.current)}. Accept the challenge: ${challengeUrl}`;
                    
                    if (navigator.share) {
                      navigator.share({ 
                        title: "WikiGo Challenge",
                        text: shareText,
                        url: challengeUrl
                      }).catch(() => {
                        // Fallback to clipboard if share is cancelled
                        navigator.clipboard.writeText(challengeUrl);
                        alert("Challenge URL copied to clipboard!");
                      });
                    } else {
                      navigator.clipboard.writeText(challengeUrl);
                      alert("Challenge URL copied to clipboard!");
                    }
                  }}
                  className={`w-full h-10 sm:h-11 md:h-12 lg:h-14 xl:h-16 text-xs sm:text-sm md:text-base lg:text-lg xl:text-xl font-semibold shadow-lg transition-all hover:scale-105 min-h-[44px] ${
                    theme === 'dark'
                      ? 'bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600 hover:from-purple-700 hover:via-pink-700 hover:to-orange-700 text-white'
                      : theme === 'classic'
                      ? 'bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 hover:from-purple-600 hover:via-pink-600 hover:to-orange-600 text-white border-2 border-black'
                      : 'bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 hover:from-purple-600 hover:via-pink-600 hover:to-orange-600 text-white'
                  }`}
                >
                  <Share2 className="h-3.5 w-3.5 sm:h-4 sm:w-4 md:h-5 md:w-5 lg:h-6 lg:w-6 mr-1 sm:mr-1.5 md:mr-2" />
                  Challenge a Friend!
                </Button>
                <p className={`text-center text-[9px] sm:text-[10px] md:text-xs lg:text-sm ${
                  theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                }`}>
                  Share your victory and challenge someone to beat your score!
                </p>
              </div>

              {/* Challenge Comparison */}
              {isChallengeMode && challengeData && (
                <div className={`p-4 sm:p-6 rounded-lg border-2 ${
                  finalScore > challengeData.score
                    ? theme === 'dark'
                      ? 'bg-gradient-to-br from-green-900/30 to-emerald-900/30 border-green-600'
                      : theme === 'classic'
                      ? 'bg-green-50 border-green-600 border-4'
                      : 'bg-gradient-to-br from-green-50 to-emerald-50 border-green-400'
                    : finalScore === challengeData.score
                    ? theme === 'dark'
                      ? 'bg-gradient-to-br from-yellow-900/30 to-orange-900/30 border-yellow-600'
                      : theme === 'classic'
                      ? 'bg-yellow-50 border-yellow-600 border-4'
                      : 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-400'
                    : theme === 'dark'
                    ? 'bg-gradient-to-br from-red-900/30 to-pink-900/30 border-red-600'
                    : theme === 'classic'
                    ? 'bg-red-50 border-red-600 border-4'
                    : 'bg-gradient-to-br from-red-50 to-pink-50 border-red-400'
                }`}>
                  <div className="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
                    {finalScore > challengeData.score ? (
                      <Trophy className={`h-5 w-5 sm:h-6 sm:w-6 ${
                        theme === 'dark' ? 'text-green-400' : 'text-green-600'
                      }`} />
                    ) : finalScore === challengeData.score ? (
                      <Target className={`h-5 w-5 sm:h-6 sm:w-6 ${
                        theme === 'dark' ? 'text-yellow-400' : 'text-yellow-600'
                      }`} />
                    ) : (
                      <Flag className={`h-5 w-5 sm:h-6 sm:w-6 ${
                        theme === 'dark' ? 'text-red-400' : 'text-red-600'
                      }`} />
                    )}
                    <h3 className={`font-semibold text-base sm:text-lg ${
                      finalScore > challengeData.score
                        ? theme === 'dark' ? 'text-green-200' : 'text-green-900'
                        : finalScore === challengeData.score
                        ? theme === 'dark' ? 'text-yellow-200' : 'text-yellow-900'
                        : theme === 'dark' ? 'text-red-200' : 'text-red-900'
                    }`}>
                      {finalScore > challengeData.score
                        ? `ðŸŽ‰ You Won! You beat ${challengeData.username}!`
                        : finalScore === challengeData.score
                        ? `ðŸ¤ It's a Tie! You matched ${challengeData.username}'s score!`
                        : `ðŸ˜” You Lost! ${challengeData.username} beat you!`}
                    </h3>
                  </div>
                  <div className="grid grid-cols-2 gap-3 sm:gap-4">
                    <div className={`p-3 sm:p-4 rounded-lg ${
                      theme === 'dark' ? 'bg-gray-800/50' : theme === 'classic' ? 'bg-white border border-slate-300' : 'bg-white/50'
                    }`}>
                      <div className={`text-xs sm:text-sm font-semibold mb-2 ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                      }`}>
                        {challengeData.username}'s Score
                      </div>
                      <div className={`text-2xl sm:text-3xl font-bold ${
                        theme === 'dark' ? 'text-white' : 'text-slate-900'
                      }`}>
                        {challengeData.score}
                      </div>
                      <div className={`text-xs mt-1 ${
                        theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                      }`}>
                        {challengeData.moves} moves â€¢ {prettyTime(challengeData.time * 1000)}
                      </div>
                    </div>
                    <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                      finalScore > challengeData.score
                        ? theme === 'dark'
                          ? 'bg-green-800/50 border-green-500'
                          : theme === 'classic'
                          ? 'bg-green-100 border-green-600'
                          : 'bg-green-100 border-green-400'
                        : theme === 'dark'
                        ? 'bg-gray-800/50 border-gray-600'
                        : theme === 'classic'
                        ? 'bg-white border-slate-400'
                        : 'bg-white/50 border-slate-300'
                    }`}>
                      <div className={`text-xs sm:text-sm font-semibold mb-2 ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                      }`}>
                        Your Score
                      </div>
                      <div className={`text-2xl sm:text-3xl font-bold ${
                        finalScore > challengeData.score
                          ? theme === 'dark' ? 'text-green-300' : 'text-green-700'
                          : theme === 'dark' ? 'text-white' : 'text-slate-900'
                      }`}>
                        {finalScore}
                      </div>
                      <div className={`text-xs mt-1 ${
                        theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                      }`}>
                        {moveCount} moves â€¢ {prettyTime(finalTime.current)}
                      </div>
                    </div>
                  </div>
                  {finalScore < challengeData.score && (
                    <div className={`mt-3 sm:mt-4 p-2 sm:p-3 rounded-lg ${
                      theme === 'dark' ? 'bg-gray-800/50' : 'bg-white/50'
                    }`}>
                      <p className={`text-xs sm:text-sm ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-700'
                      }`}>
                        ðŸ’ª Don't give up! Try again to beat {challengeData.username}'s score of {challengeData.score}!
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Journey Path */}
              <div>
                <div className="flex items-center gap-1.5 sm:gap-2 mb-2 sm:mb-3">
                  <History className={`h-4 w-4 sm:h-5 sm:w-5 ${
                    theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                  }`} />
                  <h3 className={`font-semibold text-base sm:text-lg ${
                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                  }`}>
                    Your Journey
                  </h3>
                </div>
                <div className="space-y-1.5 sm:space-y-2">
                  {history.map((article, index) => (
                    <div key={index} className={`flex items-center gap-2 sm:gap-3 p-2 sm:p-3 rounded-lg transition-colors ${
                      theme === 'dark'
                        ? 'bg-slate-800 hover:bg-slate-700'
                        : theme === 'classic'
                        ? 'bg-slate-100 hover:bg-blue-100 border border-slate-300'
                        : 'bg-slate-50 hover:bg-slate-100'
                    }`}>
                      <div className={`flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-semibold ${
                        theme === 'dark'
                          ? 'bg-slate-700 text-slate-200'
                          : theme === 'classic'
                          ? 'bg-slate-300 text-slate-900'
                          : 'bg-slate-200 text-slate-700'
                      }`}>
                        {index + 1}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`font-medium text-xs sm:text-sm break-words ${
                          theme === 'dark' ? 'text-white' : 'text-slate-900'
                        }`}>
                          {article}
                        </div>
                        {index === 0 && (
                          <div className={`text-xs mt-0.5 sm:mt-1 ${
                            theme === 'dark' ? 'text-gray-300' : 'text-slate-500'
                          }`}>
                            Start
                          </div>
                        )}
                        {index === history.length - 1 && (
                          <div className={`text-xs mt-0.5 sm:mt-1 font-semibold ${
                            theme === 'dark' ? 'text-green-400' : 'text-green-600'
                          }`}>
                            Goal reached! ðŸŽ‰
                          </div>
                        )}
                      </div>
                      {index < history.length - 1 && (
                        <div className={`flex-shrink-0 ${theme === 'dark' ? 'text-gray-400' : 'text-slate-400'}`}>
                          <svg className="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Score Breakdown - Collapsible */}
              <div className={`rounded-lg border ${
                theme === 'dark'
                  ? 'bg-slate-800 border-slate-700'
                  : theme === 'classic'
                  ? 'bg-slate-50 border-slate-400'
                  : 'bg-slate-50 border-slate-200'
              }`}>
                <button
                  onClick={() => setShowScoreBreakdown(!showScoreBreakdown)}
                  className={`w-full flex items-center justify-between p-3 sm:p-4 text-left hover:opacity-80 transition-opacity ${
                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                  }`}
                >
                  <h3 className={`font-semibold text-sm sm:text-base flex items-center gap-2 ${
                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                  }`}>
                    <History className="h-4 w-4" />
                    Score Breakdown
                  </h3>
                  {showScoreBreakdown ? (
                    <ChevronUp className={`h-4 w-4 sm:h-5 sm:w-5 ${
                      theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                    }`} />
                  ) : (
                    <ChevronDown className={`h-4 w-4 sm:h-5 sm:w-5 ${
                      theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                    }`} />
                  )}
                </button>
                {showScoreBreakdown && (
                  <div className={`px-3 sm:px-4 pb-3 sm:pb-4 pt-0 space-y-1.5 sm:space-y-2 text-xs sm:text-sm ${
                    theme === 'dark' ? 'text-gray-200' : 'text-slate-700'
                  }`}>
                    {(() => {
                      const timeToUse = finalTime.current > 0 ? finalTime.current : timer;
                      const seconds = Math.floor(timeToUse / 1000);
                      const movesPenalty = 10 * moveCount;
                      const timePenalty = seconds;
                      return (
                        <>
                          <div className="flex justify-between">
                            <span>Base score:</span>
                            <span className="font-semibold">1000</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Moves penalty (10 Ã— {moveCount}):</span>
                            <span className={`font-semibold ${
                              theme === 'dark' ? 'text-red-400' : 'text-red-600'
                            }`}>-{movesPenalty}</span>
                          </div>
                          <div className="flex justify-between">
                            <span>Time penalty (1 Ã— {seconds}s):</span>
                            <span className={`font-semibold ${
                              theme === 'dark' ? 'text-red-400' : 'text-red-600'
                            }`}>-{timePenalty}</span>
                          </div>
                          <div className={`border-t pt-1.5 sm:pt-2 mt-1.5 sm:mt-2 flex justify-between ${
                            theme === 'dark' ? 'border-gray-700' : 'border-slate-300'
                          }`}>
                            <span className="font-semibold">Final Score:</span>
                            <span className={`font-bold text-base sm:text-lg ${
                              theme === 'dark' ? 'text-white' : 'text-slate-900'
                            }`}>
                              {finalScore}
                            </span>
                          </div>
                        </>
                      );
                    })()}
                  </div>
                )}
              </div>

              {/* Daily Challenge Leaderboard Section */}
              {dailyChallenge && (
                <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                  theme === 'dark'
                    ? 'bg-gradient-to-br from-blue-900/30 to-purple-900/30 border-blue-600'
                    : theme === 'classic'
                    ? 'bg-white border-black'
                    : 'bg-gradient-to-br from-blue-50 to-purple-50 border-blue-300'
                }`}>
                  <div className="flex items-center gap-2 mb-3">
                    <Users className={`h-5 w-5 sm:h-6 sm:w-6 ${
                      theme === 'dark' ? 'text-blue-300' : theme === 'classic' ? 'text-black' : 'text-blue-600'
                    }`} />
                    <h3 className={`font-semibold text-base sm:text-lg ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      Daily Challenge Leaderboard
                    </h3>
                  </div>
                  
                  {submittingScore ? (
                    <div className="flex items-center justify-center py-4">
                      <Loader2 className={`h-6 w-6 animate-spin ${
                        theme === 'dark' ? 'text-blue-400' : 'text-blue-600'
                      }`} />
                      <span className={`ml-2 text-sm ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                      }`}>
                        Submitting your score...
                      </span>
                    </div>
                  ) : scoreSubmitted ? (
                    <div className="space-y-2">
                      <div className={`flex items-center gap-2 p-2 rounded ${
                        theme === 'dark' ? 'bg-green-900/30' : theme === 'classic' ? 'bg-green-50' : 'bg-green-50'
                      }`}>
                        <CheckCircle2 className={`h-5 w-5 ${
                          theme === 'dark' ? 'text-green-400' : 'text-green-600'
                        }`} />
                        <span className={`text-sm font-medium ${
                          theme === 'dark' ? 'text-green-200' : 'text-green-900'
                        }`}>
                          Score submitted successfully! Your username: <strong>{username}</strong>
                        </span>
                      </div>
                      <Button
                        variant="outline"
                        onClick={() => {
                          setShowLeaderboard(true);
                          setLeaderboardRefreshKey(prev => prev + 1);
                        }}
                        className="w-full mt-2"
                      >
                        <Users className="h-4 w-4 mr-2" />
                        View Leaderboard
                      </Button>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <p className={`text-sm ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                      }`}>
                        Your score will be saved to the leaderboard. Username: <strong>{username}</strong>
                      </p>
                      <div className="flex gap-2">
                        <Button
                          variant="outline"
                          onClick={() => setShowUsernameModal(true)}
                          className="flex-1"
                        >
                          Change Username
                        </Button>
                        <Button
                          onClick={() => {
                            if (won && dailyChallenge && finalTime.current > 0 && !scoreSubmitted) {
                              submitToLeaderboard();
                            }
                          }}
                          className="flex-1"
                          disabled={submittingScore}
                        >
                          {submittingScore ? (
                            <>
                              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                              Submitting...
                            </>
                          ) : (
                            'Submit Score'
                          )}
                        </Button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Secondary CTA: Play Again Button */}
              <div className="pt-2">
                <Button 
                  variant="outline" 
                  className={`w-full h-10 sm:h-11 text-sm sm:text-base ${
                    theme === 'dark'
                      ? 'border-gray-600 hover:bg-gray-800'
                      : theme === 'classic'
                      ? 'border-black hover:bg-slate-100'
                      : 'border-slate-300 hover:bg-slate-100'
                  }`}
                  onClick={resetGame}
                >
                  <PlayCircle className="h-4 w-4 mr-2" />
                  Play Again
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
      )}

      {/* Starting Game Loading Overlay */}
      {startingGame && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <Card className="w-full max-w-md shadow-2xl">
            <CardContent className="p-6 sm:p-8 flex flex-col items-center justify-center space-y-4">
              <Loader2 className="h-12 w-12 sm:h-16 sm:w-16 animate-spin text-blue-600 dark:text-blue-400" />
              <div className="text-center space-y-2">
                <h3 className={`text-lg sm:text-xl font-semibold ${
                  theme === 'dark' ? 'text-white' : 'text-slate-900'
                }`}>
                  Starting Game...
                </h3>
                <p className={`text-sm sm:text-base ${
                  theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                }`}>
                  {dailyChallenge 
                    ? "Loading today's challenge articles..." 
                    : "Fetching articles and loading Wikipedia pages..."}
                </p>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Challenge Screen Modal */}
      {showChallengeScreen && challengeData && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
          <Card className="w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
            <CardHeader className="relative bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white p-4 sm:p-6">
              <div className="flex items-center justify-center gap-2 sm:gap-3">
                <Trophy className="h-6 w-6 sm:h-8 sm:w-8" />
                <CardTitle className="text-2xl sm:text-3xl">Challenge Accepted!</CardTitle>
              </div>
              <p className="text-center mt-1 sm:mt-2 text-white/90 text-sm sm:text-base">
                {challengeData.username} has challenged you to a duel!
              </p>
              <Button
                variant="ghost"
                size="icon"
                className="absolute top-2 right-2 sm:top-4 sm:right-4 text-white hover:bg-white/20 h-8 w-8 sm:h-10 sm:w-10 min-w-[32px] sm:min-w-[40px]"
                onClick={() => {
                  setShowChallengeScreen(false);
                  // Show onboarding if needed after dismissing challenge
                  const hasSeenOnboarding = localStorage.getItem('wikiGo-onboarding-seen');
                  if (!hasSeenOnboarding) {
                    setShowOnboarding(true);
                  }
                }}
              >
                <X className="h-4 w-4 sm:h-5 sm:w-5" />
              </Button>
            </CardHeader>
            <CardContent className="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4 sm:space-y-6">
              {/* Challenge Info */}
              <div className={`p-4 sm:p-6 rounded-lg border-2 ${
                theme === 'dark'
                  ? 'bg-gradient-to-br from-purple-900/30 to-pink-900/30 border-purple-600'
                  : theme === 'classic'
                  ? 'bg-white border-black'
                  : 'bg-gradient-to-br from-purple-50 to-pink-50 border-purple-300'
              }`}>
                <h3 className={`font-semibold text-lg sm:text-xl mb-3 sm:mb-4 ${
                  theme === 'dark' ? 'text-white' : 'text-slate-900'
                }`}>
                  Beat This Score!
                </h3>
                <div className="grid grid-cols-3 gap-2 sm:gap-3">
                  <div className={`text-center p-2 sm:p-3 rounded-lg ${
                    theme === 'dark' ? 'bg-gray-800' : theme === 'classic' ? 'bg-slate-100 border border-slate-300' : 'bg-slate-50'
                  }`}>
                    <div className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      {challengeData.moves}
                    </div>
                    <div className={`text-xs sm:text-sm mt-1 ${
                      theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                    }`}>
                      Moves
                    </div>
                  </div>
                  <div className={`text-center p-2 sm:p-3 rounded-lg ${
                    theme === 'dark' ? 'bg-gray-800' : theme === 'classic' ? 'bg-slate-100 border border-slate-300' : 'bg-slate-50'
                  }`}>
                    <div className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      {prettyTime(challengeData.time * 1000)}
                    </div>
                    <div className={`text-xs sm:text-sm mt-1 ${
                      theme === 'dark' ? 'text-gray-300' : 'text-slate-600'
                    }`}>
                      Time
                    </div>
                  </div>
                  <div className={`text-center p-2 sm:p-3 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-gradient-to-br from-yellow-900/50 to-orange-900/50 border-yellow-600'
                      : theme === 'classic'
                      ? 'bg-gradient-to-br from-yellow-100 to-orange-100 border-yellow-500'
                      : 'bg-gradient-to-br from-yellow-100 to-orange-100 border-yellow-300'
                  }`}>
                    <div className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-yellow-200' : 'text-slate-900'
                    }`}>
                      {challengeData.score}
                    </div>
                    <div className={`text-xs sm:text-sm mt-1 ${
                      theme === 'dark' ? 'text-yellow-300' : 'text-slate-600'
                    }`}>
                      Score
                    </div>
                  </div>
                </div>
              </div>

              {/* Challenge Articles */}
              <div className="space-y-3 sm:space-y-4">
                <h3 className={`font-semibold text-base sm:text-lg ${
                  theme === 'dark' ? 'text-white' : 'text-slate-900'
                }`}>
                  Your Challenge:
                </h3>
                <div className="space-y-2 sm:space-y-3">
                  <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-blue-900/30 border-blue-600'
                      : theme === 'classic'
                      ? 'bg-blue-50 border-blue-500'
                      : 'bg-blue-50 border-blue-300'
                  }`}>
                    <div className={`text-xs sm:text-sm font-semibold mb-1 ${
                      theme === 'dark' ? 'text-blue-300' : 'text-blue-700'
                    }`}>
                      Start Article
                    </div>
                    <div className={`text-sm sm:text-base font-medium ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      {challengeData.start}
                    </div>
                  </div>
                  <div className="flex justify-center">
                    <ArrowRight className={`h-5 w-5 sm:h-6 sm:w-6 ${
                      theme === 'dark' ? 'text-gray-400' : 'text-slate-500'
                    }`} />
                  </div>
                  <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-green-900/30 border-green-600'
                      : theme === 'classic'
                      ? 'bg-green-50 border-green-500'
                      : 'bg-green-50 border-green-300'
                  }`}>
                    <div className={`text-xs sm:text-sm font-semibold mb-1 ${
                      theme === 'dark' ? 'text-green-300' : 'text-green-700'
                    }`}>
                      End Article
                    </div>
                    <div className={`text-sm sm:text-base font-medium ${
                      theme === 'dark' ? 'text-white' : 'text-slate-900'
                    }`}>
                      {challengeData.end}
                    </div>
                  </div>
                </div>
              </div>

              {/* Instructions */}
              <div className={`p-3 sm:p-4 rounded-lg border ${
                theme === 'dark'
                  ? 'bg-slate-800 border-slate-700'
                  : theme === 'classic'
                  ? 'bg-slate-50 border-slate-400'
                  : 'bg-slate-50 border-slate-200'
              }`}>
                <p className={`text-xs sm:text-sm ${
                  theme === 'dark' ? 'text-gray-300' : 'text-slate-700'
                }`}>
                  Navigate from <strong>{challengeData.start}</strong> to <strong>{challengeData.end}</strong> in fewer moves or less time to beat {challengeData.username}'s score of <strong>{challengeData.score}</strong>!
                </p>
              </div>
            </CardContent>
            <div className="border-t p-4 sm:p-6 flex items-center justify-end gap-3 flex-shrink-0">
              <Button
                variant="outline"
                onClick={() => {
                  setShowChallengeScreen(false);
                  // Show onboarding if needed after dismissing challenge
                  const hasSeenOnboarding = localStorage.getItem('wikiGo-onboarding-seen');
                  if (!hasSeenOnboarding) {
                    setShowOnboarding(true);
                  }
                }}
              >
                Decline
              </Button>
              <Button
                onClick={async () => {
                  // Close challenge screen and set starting flag immediately
                  setShowChallengeScreen(false);
                  setStartingGame(true);
                  try {
                    await startGame();
                  } catch (err) {
                    console.error('Error starting challenge game:', err);
                    setError("Failed to start challenge. Please try again.");
                    setStartingGame(false);
                    // Re-show challenge screen if there was an error
                    setShowChallengeScreen(true);
                  }
                }}
                className="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white"
              >
                Accept Challenge
              </Button>
            </div>
          </Card>
        </div>
      )}

      {/* Onboarding Modal */}
      {showOnboarding && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <Card className="w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
            <CardHeader className="relative p-4 sm:p-6 border-b flex-shrink-0">
              <div className="flex items-center justify-between">
                <CardTitle className="flex items-center gap-2 text-lg sm:text-xl">
                  <Compass className="h-5 w-5 sm:h-6 sm:w-6" />
                  Welcome to WikiGo!
                </CardTitle>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    localStorage.setItem('wikiGo-onboarding-seen', 'true');
                    setShowOnboarding(false);
                  }}
                  className="h-8 w-8 sm:h-10 sm:w-10"
                >
                  <X className="h-4 w-4 sm:h-5 sm:w-5" />
                </Button>
              </div>
              {/* Progress indicator */}
              <div className="flex items-center gap-2 mt-4">
                {[0, 1, 2].map((step) => (
                  <div
                    key={step}
                    className={`h-1.5 flex-1 rounded-full transition-all ${
                      step === onboardingStep
                        ? theme === 'dark'
                          ? 'bg-blue-500'
                          : theme === 'classic'
                          ? 'bg-black'
                          : 'bg-blue-600'
                        : step < onboardingStep
                        ? theme === 'dark'
                          ? 'bg-blue-700'
                          : theme === 'classic'
                          ? 'bg-black'
                          : 'bg-blue-300'
                        : theme === 'dark'
                        ? 'bg-gray-700'
                        : theme === 'classic'
                        ? 'bg-gray-400'
                        : 'bg-gray-200'
                    }`}
                  />
                ))}
              </div>
            </CardHeader>
            <CardContent className="flex-1 overflow-y-auto p-4 sm:p-6">
              {/* Step 0: Gameplay */}
              {onboardingStep === 0 && (
                <div className="space-y-4 sm:space-y-6">
                  <div className="flex items-center gap-3">
                    <div className={`p-3 rounded-lg border-2 ${
                      theme === 'dark' ? 'bg-blue-900/30' : theme === 'classic' ? 'bg-white border-black' : 'bg-blue-100'
                    }`}>
                      <PlayCircle className={`h-6 w-6 sm:h-8 sm:w-8 ${
                        theme === 'dark' ? 'text-blue-400' : theme === 'classic' ? 'text-black' : 'text-blue-600'
                      }`} />
                    </div>
                    <h3 className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                    }`}>
                      How to Play
                    </h3>
                  </div>
                  
                  <div className="space-y-3 sm:space-y-4">
                    <p className={`text-sm sm:text-base leading-relaxed ${
                      theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                    }`}>
                      Navigate from a <strong>start article</strong> to a <strong>goal article</strong> using only the links found within Wikipedia articles. Your goal is to reach your destination in the <strong>fewest moves</strong> and <strong>fastest time</strong> possible.
                    </p>
                    
                    <div className="space-y-2 sm:space-y-3">
                      <h4 className={`font-semibold text-base sm:text-lg mt-4 ${
                        theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                      }`}>
                        Quick Steps:
                      </h4>
                      <ol className="space-y-2 sm:space-y-3 text-sm sm:text-base">
                        {[
                          "Set your start and goal articles using the Setup section",
                          "Click Start to begin your journey",
                          "Click on any blue link in the article to navigate",
                          "Use the Available Links panel to find links quickly",
                          "Reach the goal article to win!"
                        ].map((step, idx) => (
                          <li key={idx} className="flex items-start gap-3">
                            <span className={`flex-shrink-0 w-6 h-6 sm:w-7 sm:h-7 rounded-full flex items-center justify-center font-semibold text-xs sm:text-sm border-2 ${
                              theme === 'dark'
                                ? 'bg-blue-600 text-white'
                                : theme === 'classic'
                                ? 'bg-black text-white border-black'
                                : 'bg-blue-100 text-blue-700'
                            }`}>
                              {idx + 1}
                            </span>
                            <span className={`flex-1 pt-0.5 ${
                              theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                            }`}>
                              {step}
                            </span>
                          </li>
                        ))}
                      </ol>
                    </div>
                  </div>
                </div>
              )}

              {/* Step 1: Example Journey */}
              {onboardingStep === 1 && (
                <div className="space-y-4 sm:space-y-6">
                  <div className="flex items-center gap-3">
                    <div className={`p-3 rounded-lg border-2 ${
                      theme === 'dark' ? 'bg-purple-900/30' : theme === 'classic' ? 'bg-white border-black' : 'bg-purple-100'
                    }`}>
                      <BookOpen className={`h-6 w-6 sm:h-8 sm:w-8 ${
                        theme === 'dark' ? 'text-purple-400' : theme === 'classic' ? 'text-black' : 'text-purple-600'
                      }`} />
                    </div>
                    <h3 className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                    }`}>
                      Example Journey
                    </h3>
                  </div>
                  
                  <p className={`text-sm sm:text-base leading-relaxed ${
                    theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                  }`}>
                    Here's an example of how you might navigate from one article to another:
                  </p>
                  
                  <div className={`p-4 sm:p-5 rounded-lg border-2 ${
                    theme === 'dark'
                      ? 'bg-gradient-to-br from-purple-900/20 to-blue-900/20 border-purple-700/50'
                      : theme === 'classic'
                      ? 'bg-white border-black'
                      : 'bg-gradient-to-br from-purple-50 to-blue-50 border-purple-200'
                  }`}>
                    <div className="space-y-3 sm:space-y-4">
                      {[
                        { num: 1, title: "Start: Alan Turing", desc: "Mathematician and computer scientist" },
                        { num: 2, title: "Click link: Computer Science", desc: "Found in Alan Turing article" },
                        { num: 3, title: "Click link: Artificial Intelligence", desc: "Found in Computer Science article" },
                        { num: 4, title: "Goal: Machine Learning", desc: "Found in Artificial Intelligence article âœ“", isGoal: true }
                      ].map((item, idx) => (
                        <div key={idx}>
                          <div className={`flex items-center gap-3 p-3 rounded-lg border-2 ${
                            item.isGoal
                              ? theme === 'dark'
                                ? 'bg-green-900/30 border-2 border-green-600'
                                : theme === 'classic'
                                ? 'bg-white border-black border-4'
                                : 'bg-green-50 border-2 border-green-300'
                              : theme === 'dark'
                              ? 'bg-slate-800/50 border border-slate-700'
                              : theme === 'classic'
                              ? 'bg-white border-black'
                              : 'bg-white border border-slate-200'
                          }`}>
                            <div className={`flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center font-semibold text-sm sm:text-base border-2 ${
                              item.isGoal
                                ? theme === 'dark'
                                  ? 'bg-green-600 text-white'
                                  : theme === 'classic'
                                  ? 'bg-black text-white border-black'
                                  : 'bg-green-100 text-green-700'
                                : theme === 'dark'
                                ? 'bg-blue-600 text-white'
                                : theme === 'classic'
                                ? 'bg-black text-white border-black'
                                : 'bg-blue-100 text-blue-700'
                            }`}>
                              {item.isGoal ? <CheckCircle2 className={`h-5 w-5 sm:h-6 sm:w-6 ${theme === 'classic' ? 'text-white' : ''}`} /> : item.num}
                            </div>
                            <div className="flex-1 min-w-0">
                              <div className={`font-medium text-sm sm:text-base ${
                                item.isGoal
                                  ? theme === 'dark' ? 'text-green-200' : theme === 'classic' ? 'text-black' : 'text-green-900'
                                  : theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                              }`}>
                                {item.title}
                              </div>
                              <div className={`text-xs sm:text-sm mt-0.5 ${
                                item.isGoal
                                  ? theme === 'dark' ? 'text-green-300' : theme === 'classic' ? 'text-black' : 'text-green-700'
                                  : theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-black' : 'text-slate-500'
                              }`}>
                                {item.desc}
                              </div>
                            </div>
                          </div>
                          {idx < 3 && (
                            <div className="flex justify-center my-2">
                              <ArrowRight className={`h-5 w-5 sm:h-6 sm:w-6 ${
                                theme === 'dark' ? 'text-gray-500' : theme === 'classic' ? 'text-black' : 'text-slate-400'
                              }`} />
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                    <p className={`text-xs sm:text-sm italic mt-4 pt-4 border-t ${
                      theme === 'dark' ? 'border-slate-700 text-gray-400' : theme === 'classic' ? 'border-black text-black' : 'border-slate-200 text-slate-600'
                    }`}>
                      <strong>Tip:</strong> In this example, we used 3 moves. Try to find even shorter paths!
                    </p>
                  </div>
                </div>
              )}

              {/* Step 2: Scoring */}
              {onboardingStep === 2 && (
                <div className="space-y-4 sm:space-y-6">
                  <div className="flex items-center gap-3">
                    <div className={`p-3 rounded-lg border-2 ${
                      theme === 'dark' ? 'bg-yellow-900/30' : theme === 'classic' ? 'bg-white border-black' : 'bg-yellow-100'
                    }`}>
                      <Trophy className={`h-6 w-6 sm:h-8 sm:w-8 ${
                        theme === 'dark' ? 'text-yellow-400' : theme === 'classic' ? 'text-black' : 'text-yellow-600'
                      }`} />
                    </div>
                    <h3 className={`text-xl sm:text-2xl font-bold ${
                      theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-black' : 'text-slate-900'
                    }`}>
                      Scoring System
                    </h3>
                  </div>
                  
                  <div className="space-y-3 sm:space-y-4">
                    <p className={`text-sm sm:text-base leading-relaxed ${
                      theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-black' : 'text-slate-700'
                    }`}>
                      Your score rewards efficiencyâ€”fewer moves and faster time mean higher scores!
                    </p>
                    
                    <div className={`p-4 sm:p-5 rounded-lg border-2 ${
                      theme === 'dark'
                        ? 'bg-slate-800/50 border-slate-700'
                        : theme === 'classic'
                        ? 'bg-white border-black'
                        : 'bg-blue-50/50 border-blue-200'
                    }`}>
                      <div className={`font-mono text-base sm:text-lg font-semibold mb-3 text-center ${
                        theme === 'dark' ? 'text-blue-300' : theme === 'classic' ? 'text-black' : 'text-blue-700'
                      }`}>
                        Score = 1000 âˆ’ (10 Ã— moves) âˆ’ (1 Ã— seconds)
                      </div>
                      <div className="space-y-2 text-sm sm:text-base">
                        <div className="flex items-start gap-2">
                          <span className="font-semibold">â€¢</span>
                          <span><strong>Base Score:</strong> Start with 1000 points</span>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="font-semibold">â€¢</span>
                          <span><strong>Move Penalty:</strong> Lose 10 points per move</span>
                        </div>
                        <div className="flex items-start gap-2">
                          <span className="font-semibold">â€¢</span>
                          <span><strong>Time Penalty:</strong> Lose 1 point per second</span>
                        </div>
                      </div>
                    </div>
                    
                    <div className={`p-3 sm:p-4 rounded-lg border-2 ${
                      theme === 'dark'
                        ? 'bg-yellow-900/20 border border-yellow-800/50'
                        : theme === 'classic'
                        ? 'bg-white border-black'
                        : 'bg-yellow-50 border border-yellow-200'
                    }`}>
                      <p className={`text-xs sm:text-sm ${
                        theme === 'dark' ? 'text-yellow-200' : theme === 'classic' ? 'text-black' : 'text-yellow-900'
                      }`}>
                        <strong>ðŸ’¡ Pro Tip:</strong> Plan your path before clicking! Use link structure intuitionâ€”jump to broad categories, then narrow in. Beat your personal best by optimizing both moves and time.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </CardContent>
            <div className="border-t p-4 sm:p-6 flex items-center justify-between gap-3 flex-shrink-0">
              <Button
                variant="outline"
                onClick={() => {
                  if (onboardingStep > 0) {
                    setOnboardingStep(onboardingStep - 1);
                  } else {
                    localStorage.setItem('wikiGo-onboarding-seen', 'true');
                    setShowOnboarding(false);
                  }
                }}
                className="flex items-center gap-2"
              >
                {onboardingStep > 0 ? (
                  <>
                    <ChevronLeft className="h-4 w-4" />
                    Previous
                  </>
                ) : (
                  'Skip'
                )}
              </Button>
              
              <div className="flex items-center gap-2">
                {[0, 1, 2].map((step) => (
                  <div
                    key={step}
                    className={`h-2 w-2 rounded-full ${
                      step === onboardingStep
                        ? theme === 'dark' ? 'bg-blue-500' : theme === 'classic' ? 'bg-black' : 'bg-blue-600'
                        : theme === 'dark' ? 'bg-gray-600' : theme === 'classic' ? 'bg-gray-400' : 'bg-gray-300'
                    }`}
                  />
                ))}
              </div>
              
              <Button
                onClick={() => {
                  if (onboardingStep < 2) {
                    setOnboardingStep(onboardingStep + 1);
                  } else {
                    localStorage.setItem('wikiGo-onboarding-seen', 'true');
                    setShowOnboarding(false);
                  }
                }}
                className="flex items-center gap-2"
              >
                {onboardingStep < 2 ? (
                  <>
                    Next
                    <ChevronRight className="h-4 w-4" />
                  </>
                ) : (
                  'Get Started'
                )}
              </Button>
            </div>
          </Card>
        </div>
      )}

      {/* Username Modal */}
      {showUsernameModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
          <Card className="w-full max-w-md shadow-2xl">
            <CardHeader className="p-4 sm:p-6">
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg sm:text-xl">Set Your Username</CardTitle>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => {
                    setShowUsernameModal(false);
                    setUsernameInput("");
                  }}
                  className="h-8 w-8 sm:h-10 sm:w-10"
                >
                  <X className="h-4 w-4 sm:h-5 sm:w-5" />
                </Button>
              </div>
            </CardHeader>
            <CardContent className="p-4 sm:p-6 space-y-4">
              <p className={`text-sm ${
                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
              }`}>
                {pendingSubmission 
                  ? "Choose a username to display on the leaderboard before submitting your score, or keep your current one."
                  : "Choose a username to display on the leaderboard, or use your current one."}
              </p>
              <div className="space-y-2">
                <Input
                  placeholder="Enter username"
                  value={usernameInput}
                  onChange={(e) => setUsernameInput(e.target.value)}
                  maxLength={30}
                  className="text-sm"
                />
                <div className={`text-xs ${
                  theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-black' : 'text-slate-500'
                }`}>
                  Current: <strong>{username}</strong>
                </div>
              </div>
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => {
                    setShowUsernameModal(false);
                    setUsernameInput("");
                  }}
                  className="flex-1"
                >
                  Cancel
                </Button>
                <Button
                  onClick={async () => {
                    const newUsername = usernameInput.trim() || username;
                    if (newUsername && newUsername !== username) {
                      const oldUsername = username;
                      // Update username across all database tables
                      await updateUsernameAcrossTables(oldUsername, newUsername);
                      setStoredUsername(newUsername, false); // Mark as user-set
                      setUsername(newUsername);
                      setShowUsernameModal(false);
                      setUsernameInput("");
                      setPendingSubmission(false);
                      // Submit score after username is confirmed
                      if (won && dailyChallenge && finalTime.current > 0 && !scoreSubmitted) {
                        submitToLeaderboard();
                      }
                    } else if (newUsername === username) {
                      // Username didn't change, just close modal
                      setShowUsernameModal(false);
                      setUsernameInput("");
                      setPendingSubmission(false);
                      // Submit score if needed
                      if (won && dailyChallenge && finalTime.current > 0 && !scoreSubmitted) {
                        submitToLeaderboard();
                      }
                    }
                  }}
                  className="flex-1"
                  disabled={!usernameInput.trim() && username}
                >
                  {pendingSubmission ? 'Save & Submit Score' : 'Save'}
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Leaderboard Modal */}
      {showLeaderboard && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[60] flex items-center justify-center p-4 overflow-y-auto">
          <Card className="w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col my-4">
            <CardHeader className="relative p-4 sm:p-6 border-b flex-shrink-0">
              <div className="flex items-center justify-between">
                <CardTitle className="flex items-center gap-2 text-lg sm:text-xl">
                  <Users className="h-5 w-5 sm:h-6 sm:w-6" />
                  Leaderboard
                </CardTitle>
                <div className="flex items-center gap-2">
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => setShowUsernameModal(true)}
                    className="h-8 w-8 sm:h-10 sm:w-10 px-2"
                    title={`Change username (${username})`}
                  >
                    <span className={`text-xs sm:text-sm truncate max-w-[80px] ${
                      theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-black' : 'text-slate-600'
                    }`}>
                      {username}
                    </span>
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => setShowLeaderboard(false)}
                    className="h-8 w-8 sm:h-10 sm:w-10"
                  >
                    <X className="h-4 w-4 sm:h-5 sm:w-5" />
                  </Button>
                </div>
              </div>
            </CardHeader>
            <CardContent className="flex-1 overflow-y-auto p-4 sm:p-6">
              <Leaderboard key={leaderboardRefreshKey} onRefresh={submittingScore} />
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}


