<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiGo - Wikipedia Journey Game</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.4/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom styles for line-clamp */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- Utilities ---
        const API = "https://en.wikipedia.org/w/api.php?origin=*";

        // Daily Challenge utilities
        function getDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        function seededRandom(seed) {
            // Simple seeded random number generator (Linear Congruential Generator)
            let value = seed;
            return function() {
                value = (value * 9301 + 49297) % 233280;
                return value / 233280;
            };
        }

        function getDailyChallengeSeeds() {
            const dateStr = getDateString();
            const baseHash = hashString(dateStr);
            return {
                startSeed: baseHash,
                goalSeed: hashString(dateStr + '_goal'),
            };
        }

        function getTimeUntilMidnight() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            return midnight.getTime() - now.getTime();
        }

        // Predefined categories for dropdown
        const CATEGORIES = [
            { value: "", label: "Any Category" },
            { value: "Physics", label: "Physics" },
            { value: "Mathematics", label: "Mathematics" },
            { value: "Biology", label: "Biology" },
            { value: "Chemistry", label: "Chemistry" },
            { value: "History", label: "History" },
            { value: "Geography", label: "Geography" },
            { value: "Literature", label: "Literature" },
            { value: "Music", label: "Music" },
            { value: "Film", label: "Film" },
            { value: "Sports", label: "Sports" },
            { value: "Technology", label: "Technology" },
            { value: "Philosophy", label: "Philosophy" },
            { value: "Art", label: "Art" },
            { value: "Medicine", label: "Medicine" },
            { value: "Astronomy", label: "Astronomy" },
        ];

        // Special category mappings for categories that should fetch from multiple related categories
        const CATEGORY_EXPANSIONS = {
        };

        // Icon components (SVG) - Lucide React icons
        const Compass = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/>
            </svg>
        );

        const Timer = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="10" x2="14" y1="2" y2="2"/>
                <line x1="12" x2="15" y1="14" y2="11"/>
                <circle cx="12" cy="14" r="8"/>
            </svg>
        );

        const Target = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
        );

        const Shuffle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="16 3 21 3 21 8"/>
                <line x1="4" x2="21" y1="21" y2="3"/>
                <polyline points="21 16 21 21 16 21"/>
                <line x1="15" x2="21" y1="15" y2="21"/>
                <line x1="21" x2="9" y1="3" y2="15"/>
            </svg>
        );

        const Flag = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                <line x1="4" x2="4" y1="22" y2="15"/>
            </svg>
        );

        const History = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 3v5h5"/>
                <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
                <path d="M12 7v5l4 2"/>
            </svg>
        );

        const Trophy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
                <path d="M4 22h16"/>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="18" x2="6" y1="6" y2="18"/>
                <line x1="6" x2="18" y1="6" y2="18"/>
            </svg>
        );

        const ArrowLeft = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m12 19-7-7 7-7"/>
                <path d="M19 12H5"/>
            </svg>
        );

        const Loader2 = ({ className }) => (
            <svg className={`${className} animate-spin`} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
        );

        const Calendar = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const Search = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
        );

        const Eye = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const EyeOff = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" x2="23" y1="1" y2="23"/>
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        );

        const ChevronUp = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="m18 15-6-6-6 6"/>
            </svg>
        );

        const Moon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        );

        const Sun = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="4"/>
                <path d="M12 2v2"/>
                <path d="M12 20v2"/>
                <path d="m4.93 4.93 1.41 1.41"/>
                <path d="m17.66 17.66 1.41 1.41"/>
                <path d="M2 12h2"/>
                <path d="M20 12h2"/>
                <path d="m6.34 17.66-1.41 1.41"/>
                <path d="m19.07 4.93-1.41 1.41"/>
            </svg>
        );


        // Utility functions
        async function fetchRandomTitle() {
            const url = `${API}&action=query&list=random&rnnamespace=0&rnlimit=1&format=json`;
            const res = await fetch(url);
            const data = await res.json();
            const title = data?.query?.random?.[0]?.title;
            return title || null;
        }

        async function fetchRandomTitleFromCategory(categoryName, seed = null) {
            if (!categoryName) return null;
            
            // Check if this category has expansions (multiple related categories)
            const categoriesToFetch = CATEGORY_EXPANSIONS[categoryName] || [categoryName];
            
            // Limit to first 7 categories for speed (or all if less than 7)
            const limitedCategories = categoriesToFetch.slice(0, 7);
            
            // Fetch articles from categories in parallel for speed
            const fetchPromises = limitedCategories.map(async (cat) => {
                const categoryUrl = `${API}&action=query&list=categorymembers&cmtitle=Category:${encodeURIComponent(cat)}&cmlimit=100&cmnamespace=0&format=json`;
                
                try {
                    const res = await fetch(categoryUrl);
                    const data = await res.json();
                    const members = data?.query?.categorymembers || [];
                    
                    // Filter to only articles (not subcategories or files)
                    const articles = members
                        .filter(m => m.ns === 0) // ns=0 means main namespace (articles)
                        .map(m => m.title);
                    
                    return articles;
                } catch (e) {
                    console.error(`Error fetching articles from category ${cat}:`, e);
                    return [];
                }
            });
            
            // Wait for all fetches to complete (in parallel)
            const results = await Promise.all(fetchPromises);
            
            // Flatten and remove duplicates
            let allArticles = [...new Set(results.flat())];
            
            // Sort articles for deterministic selection
            allArticles.sort();
            
            // Select one deterministically if seed provided, otherwise randomly
            if (allArticles.length === 0) return null;
            let randomIndex;
            if (seed !== null) {
                const rng = seededRandom(seed);
                randomIndex = Math.floor(rng() * allArticles.length);
            } else {
                randomIndex = Math.floor(Math.random() * allArticles.length);
            }
            return allArticles[randomIndex];
        }

        async function fetchDailyChallengeArticles() {
            const seeds = getDailyChallengeSeeds();
            
            // Use a mix of categories for variety, but deterministically based on date
            const allCategories = CATEGORIES.filter(c => c.value !== "").map(c => c.value);
            const dateStr = getDateString();
            const categorySeed = hashString(dateStr + '_category');
            const rng = seededRandom(categorySeed);
            
            // Select start and goal categories deterministically
            const startCategoryIndex = Math.floor(rng() * allCategories.length);
            const goalCategoryIndex = Math.floor(rng() * allCategories.length);
            
            const startCategory = allCategories[startCategoryIndex];
            const goalCategory = allCategories[goalCategoryIndex];
            
            const [startTitle, goalTitle] = await Promise.all([
                fetchRandomTitleFromCategory(startCategory, seeds.startSeed),
                fetchRandomTitleFromCategory(goalCategory, seeds.goalSeed),
            ]);
            
            return { startTitle, goalTitle };
        }

        async function fetchLinks(title) {
            let allLinks = [];
            let continueToken = null;
            const MAX_LINKS = 1500;
            
            do {
                let url = `${API}&action=query&prop=links&plnamespace=0&pllimit=500&format=json&titles=${encodeURIComponent(title)}`;
                if (continueToken) {
                    url += `&plcontinue=${encodeURIComponent(continueToken)}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                const pages = data?.query?.pages || {};
                const firstPage = Object.values(pages)[0];
                const links = (firstPage?.links || []).map((l) => l.title);
                allLinks = allLinks.concat(links);
                
                if (allLinks.length >= MAX_LINKS) {
                    allLinks = allLinks.slice(0, MAX_LINKS);
                    break;
                }
                
                continueToken = data?.continue?.plcontinue || null;
            } while (continueToken);
            
            return allLinks;
        }

        async function fetchArticleHTML(title) {
            // Fetch mobile HTML version which is cleaner and easier to style
            const url = `https://en.wikipedia.org/api/rest_v1/page/html/${encodeURIComponent(title)}`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const html = await res.text();
                return html;
            } catch (e) {
                console.error('Error fetching article HTML:', e);
                return null;
            }
        }

        async function fetchSummary(title) {
            const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            return {
                title: data.title,
                description: data.description,
                extract: data.extract,
                thumbnail: data.thumbnail?.source || null,
                url: data.content_urls?.desktop?.page || `https://en.wikipedia.org/wiki/${encodeURIComponent(title)}`,
            };
        }

        function prettyTime(ms) {
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec.toString().padStart(2, "0")}`;
        }

        function useTimer(active) {
            const [start, setStart] = useState(null);
            const [now, setNow] = useState(null);
            useEffect(() => {
                let id;
                if (active) {
                    const t0 = Date.now();
                    setStart(t0);
                    setNow(t0);
                    id = setInterval(() => setNow(Date.now()), 250);
                }
                return () => id && clearInterval(id);
            }, [active]);
            return start && now ? now - start : 0;
        }

        // UI Components
        const Card = ({ className, children, ...props }) => (
            <div className={`rounded-lg border shadow-sm dark:border-gray-800 dark:bg-gray-900 dark:text-gray-100 classic:border-slate-400 classic:bg-white classic:text-slate-950 border-slate-200 bg-white text-slate-950 ${className || ''}`} {...props}>
                {children}
            </div>
        );

        const CardHeader = ({ className, children, ...props }) => (
            <div className={`flex flex-col space-y-1.5 p-3 sm:p-6 ${className || ''}`} {...props}>
                {children}
            </div>
        );

        const CardTitle = ({ className, children, ...props }) => (
            <h3 className={`text-base sm:text-lg md:text-2xl font-semibold leading-none tracking-tight dark:text-gray-100 classic:text-slate-900 text-slate-950 ${className || ''}`} {...props}>
                {children}
            </h3>
        );

        const CardContent = ({ className, children, ...props }) => (
            <div className={`p-3 sm:p-6 pt-0 ${className || ''}`} {...props}>
                {children}
            </div>
        );

        const Button = ({ className, variant = "default", size = "default", children, ...props }) => {
            const baseClasses = "inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 classic:ring-offset-white classic:focus-visible:ring-blue-600";
            const variants = {
                default: "bg-slate-900 text-slate-50 hover:bg-slate-900/90 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-100 classic:bg-blue-600 classic:text-white classic:hover:bg-blue-700",
                outline: "border border-slate-200 bg-white hover:bg-slate-100 hover:text-slate-900 dark:border-gray-800 dark:bg-gray-900 dark:hover:bg-gray-800 dark:text-gray-200 classic:border-slate-400 classic:bg-white classic:hover:bg-blue-50 classic:text-slate-900",
                secondary: "bg-slate-100 text-slate-900 hover:bg-slate-100/80 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700 classic:bg-slate-200 classic:text-slate-900 classic:hover:bg-slate-300",
                ghost: "hover:bg-slate-100 hover:text-slate-900 dark:hover:bg-gray-800 dark:text-gray-200 classic:hover:bg-blue-50 classic:text-slate-900",
            };
            const sizes = {
                default: "h-10 px-4 py-2",
                icon: "h-10 w-10",
                sm: "h-9 px-3 text-sm",
            };
            return (
                <button className={`${baseClasses} ${variants[variant]} ${sizes[size] || sizes.default} ${className || ''}`} {...props}>
                    {children}
                </button>
            );
        };

        const Input = ({ className, type = "text", ...props }) => (
            <input
                type={type}
                className={`flex h-10 w-full rounded-md border px-3 py-2 text-sm ring-offset-white placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-200 dark:placeholder:text-gray-400 classic:ring-offset-white classic:focus-visible:ring-blue-600 classic:border-slate-400 classic:bg-white classic:text-slate-900 border-slate-200 bg-white ${className || ''}`}
                {...props}
            />
        );

        const Badge = ({ className, variant = "default", children, ...props }) => {
            const variants = {
                default: "border-transparent bg-slate-900 text-slate-50 hover:bg-slate-900/80 dark:bg-gray-800 dark:hover:bg-gray-700 dark:text-gray-100",
                secondary: "border-transparent bg-slate-100 text-slate-900 hover:bg-slate-100/80 dark:bg-gray-800 dark:text-gray-200 dark:hover:bg-gray-700",
            };
            return (
                <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors ${variants[variant]} ${className || ''}`} {...props}>
                    {children}
                </div>
            );
        };

        const Progress = ({ className, value = 0, ...props }) => (
            <div className={`relative h-4 w-full overflow-hidden rounded-full bg-slate-200 dark:bg-gray-800 ${className || ''}`} {...props}>
                <div className="h-full bg-slate-900 dark:bg-gray-600 transition-all" style={{ width: `${value || 0}%` }} />
            </div>
        );

        // Theme Context
        const ThemeContext = React.createContext();

        function ThemeProvider({ children }) {
            const [theme, setTheme] = useState(() => {
                const saved = localStorage.getItem('wiki-journey-theme');
                // Migrate 'classic' theme to 'light' if found
                if (saved === 'classic') {
                    localStorage.setItem('wiki-journey-theme', 'light');
                    return 'light';
                }
                return saved || 'light';
            });

            useEffect(() => {
                localStorage.setItem('wiki-journey-theme', theme);
                document.documentElement.className = theme;
                document.documentElement.classList.remove('light', 'dark', 'classic');
                document.documentElement.classList.add(theme);
            }, [theme]);

            return (
                <ThemeContext.Provider value={{ theme, setTheme }}>
                    {children}
                </ThemeContext.Provider>
            );
        }

        function useTheme() {
            const context = React.useContext(ThemeContext);
            if (!context) {
                throw new Error('useTheme must be used within ThemeProvider');
            }
            return context;
        }

        // Theme Switcher Component
        function ThemeSwitcher() {
            const { theme, setTheme } = useTheme();
            const themes = [
                { value: 'light', label: 'Light', icon: Sun },
                { value: 'dark', label: 'Dark', icon: Moon },
            ];

            return (
                <div className="flex items-center gap-2 p-1 rounded-lg border border-slate-200 bg-white dark:bg-gray-900 dark:border-gray-800">
                    {themes.map(({ value, label, icon: Icon }) => (
                        <Button
                            key={value}
                            variant={theme === value ? 'default' : 'ghost'}
                            size="sm"
                            onClick={() => setTheme(value)}
                            className={`flex items-center gap-1.5 ${
                                theme === value
                                    ? 'bg-slate-900 text-white dark:bg-gray-800 dark:text-gray-100'
                                    : 'text-slate-600 dark:text-gray-300 hover:bg-slate-100 dark:hover:bg-gray-800'
                            }`}
                            title={label}
                        >
                            <Icon className="h-4 w-4" />
                            <span className="hidden sm:inline">{label}</span>
                        </Button>
                    ))}
                </div>
            );
        }

        // Wikipedia Article Viewer Component
        function WikipediaArticleViewer({ html, onLinkClick, theme }) {
            const articleRef = useRef(null);
            const styleRef = useRef(null);

            useEffect(() => {
                if (!html || !articleRef.current) return;

                const container = articleRef.current;
                container.innerHTML = html;

                // Hide search bar and other Wikipedia UI elements
                const style = document.createElement('style');
                style.id = 'wikipedia-article-viewer-style';
                styleRef.current = style;
                style.textContent = `
                    .wikipedia-article-viewer #mw-head,
                    .wikipedia-article-viewer #mw-navigation,
                    .wikipedia-article-viewer .mw-jump-link,
                    .wikipedia-article-viewer .mw-editsection,
                    .wikipedia-article-viewer .mw-indicators,
                    .wikipedia-article-viewer .noprint,
                    .wikipedia-article-viewer .navbox,
                    .wikipedia-article-viewer .infobox,
                    .wikipedia-article-viewer .thumb,
                    .wikipedia-article-viewer .toc,
                    .wikipedia-article-viewer .mw-heading,
                    .wikipedia-article-viewer header,
                    .wikipedia-article-viewer .vector-header-container,
                    .wikipedia-article-viewer .vector-page-toolbar,
                    .wikipedia-article-viewer .vector-page-titlebar,
                    .wikipedia-article-viewer .vector-sticky-header,
                    .wikipedia-article-viewer .mw-search-container,
                    .wikipedia-article-viewer #searchform,
                    .wikipedia-article-viewer .cdx-search-input,
                    .wikipedia-article-viewer .vector-search-box {
                        display: none !important;
                    }
                    .wikipedia-article-viewer {
                        ${theme === 'dark' 
                            ? 'background: #030712; color: #f3f4f6;' 
                            : theme === 'classic'
                            ? 'background: white; color: #1e293b;'
                            : 'background: white; color: #1e293b;'}
                        padding: 1rem;
                        max-height: calc(100vh - 180px);
                        overflow-y: auto;
                        -webkit-overflow-scrolling: touch;
                    }
                    @media (min-width: 768px) {
                        .wikipedia-article-viewer {
                            padding: 1.5rem;
                            max-height: calc(100vh - 200px);
                        }
                    }
                    .wikipedia-article-viewer a {
                        ${theme === 'dark'
                            ? 'color: #60a5fa;'
                            : theme === 'classic'
                            ? 'color: #0645ad;'
                            : 'color: #2563eb;'}
                        cursor: pointer;
                        text-decoration: underline;
                        touch-action: manipulation;
                        min-height: 44px;
                        display: inline-block;
                        padding: 2px 0;
                    }
                    .wikipedia-article-viewer a:visited {
                        ${theme === 'dark'
                            ? 'color: #a78bfa;'
                            : theme === 'classic'
                            ? 'color: #0b0080;'
                            : 'color: #7c3aed;'}
                    }
                    .wikipedia-article-viewer a:hover,
                    .wikipedia-article-viewer a:active {
                        ${theme === 'dark'
                            ? 'color: #93c5fd;'
                            : theme === 'classic'
                            ? 'color: #0645ad;'
                            : 'color: #3b82f6;'}
                    }
                    .wikipedia-article-viewer h1,
                    .wikipedia-article-viewer h2,
                    .wikipedia-article-viewer h3 {
                        ${theme === 'dark' ? 'color: #f1f5f9;' : 'color: #0f172a;'}
                        margin-top: 1rem;
                        margin-bottom: 0.5rem;
                        font-size: 1.25rem;
                    }
                    @media (min-width: 768px) {
                        .wikipedia-article-viewer h1,
                        .wikipedia-article-viewer h2,
                        .wikipedia-article-viewer h3 {
                            margin-top: 1.5rem;
                            margin-bottom: 0.75rem;
                        }
                        .wikipedia-article-viewer h1 {
                            font-size: 1.875rem;
                        }
                        .wikipedia-article-viewer h2 {
                            font-size: 1.5rem;
                        }
                        .wikipedia-article-viewer h3 {
                            font-size: 1.25rem;
                        }
                    }
                    .wikipedia-article-viewer p {
                        margin-bottom: 0.875rem;
                        line-height: 1.6;
                        font-size: 0.9375rem;
                    }
                    @media (min-width: 768px) {
                        .wikipedia-article-viewer p {
                            margin-bottom: 1rem;
                            font-size: 1rem;
                        }
                    }
                    .wikipedia-article-viewer img {
                        max-width: 100%;
                        height: auto;
                    }
                `;
                
                // Remove existing style if present
                const existingStyle = document.getElementById('wikipedia-article-viewer-style');
                if (existingStyle) {
                    existingStyle.remove();
                }
                
                document.head.appendChild(style);

                // Intercept all link clicks
                const links = container.querySelectorAll('a[href]');
                links.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const href = link.getAttribute('href');
                        if (!href) return;

                        // Extract article title from Wikipedia URL
                        let title = null;
                        if (href.startsWith('/wiki/')) {
                            title = decodeURIComponent(href.replace('/wiki/', ''));
                        } else if (href.includes('wikipedia.org/wiki/')) {
                            const match = href.match(/wiki\/([^?#]+)/);
                            if (match) {
                                title = decodeURIComponent(match[1]);
                            }
                        }

                        // Only navigate if it's a valid article link
                        if (title && !title.startsWith('Special:') && !title.startsWith('File:') && !title.startsWith('Category:') && !title.startsWith('Template:') && !title.startsWith('Help:') && !title.startsWith('User:')) {
                            title = title.replace(/_/g, ' ');
                            onLinkClick(title);
                        }
                    });
                });

                return () => {
                    if (styleRef.current && styleRef.current.parentNode) {
                        styleRef.current.parentNode.removeChild(styleRef.current);
                    }
                };
            }, [html, onLinkClick, theme]);

            if (!html) {
                return (
                    <div className={`flex items-center justify-center h-full p-4 md:p-8 ${
                        theme === 'dark' ? 'text-gray-300' : 'text-slate-500'
                    }`}>
                        <div className="text-center">
                            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
                            <p className="text-sm md:text-base">Loading article...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div 
                    ref={articleRef} 
                    className="wikipedia-article-viewer"
                    style={{ 
                        maxHeight: 'calc(100vh - 180px)',
                        overflowY: 'auto',
                        WebkitOverflowScrolling: 'touch'
                    }}
                />
            );
        }

        // Main Component
        function WikipediaJourneyGame() {
            const { theme } = useTheme();
            
            // Setup
            const [startTitle, setStartTitle] = useState("");
            const [goalTitle, setGoalTitle] = useState("");
            const [startCategory, setStartCategory] = useState("");
            const [goalCategory, setGoalCategory] = useState("");
            const [startSummary, setStartSummary] = useState(null);
            const [goalSummary, setGoalSummary] = useState(null);
            const [currentTitle, setCurrentTitle] = useState(null);
            const [summary, setSummary] = useState(null);
            const [articleHTML, setArticleHTML] = useState(null);
            const [links, setLinks] = useState([]);
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(false);
            const [loadingStartRandom, setLoadingStartRandom] = useState(false);
            const [loadingGoalRandom, setLoadingGoalRandom] = useState(false);
            const [error, setError] = useState("");
            const [gameActive, setGameActive] = useState(false);
            const [won, setWon] = useState(false);
            const [dailyChallenge, setDailyChallenge] = useState(false);
            const [timeUntilReset, setTimeUntilReset] = useState(getTimeUntilMidnight());
            const timer = useTimer(gameActive && !won);
            const dailyChallengeLoadedRef = useRef(false);
            const [searchQuery, setSearchQuery] = useState("");
            const [showArticleOnMobile, setShowArticleOnMobile] = useState(false);
            const [setupCollapsed, setSetupCollapsed] = useState(false);

            const progress = useMemo(() => {
                if (!goalTitle || !currentTitle) return 0;
                const a = new Set(goalTitle.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean));
                const b = new Set(currentTitle.toLowerCase().split(/[^a-z0-9]+/).filter(Boolean));
                const inter = [...a].filter((x) => b.has(x)).length;
                const union = new Set([...a, ...b]).size || 1;
                return Math.round((inter / union) * 100);
            }, [goalTitle, currentTitle]);

            async function loadPage(title, pushHistory = true) {
                try {
                    setLoading(true);
                    setError("");
                    const [sum, lks, html] = await Promise.all([
                        fetchSummary(title), 
                        fetchLinks(title),
                        fetchArticleHTML(title)
                    ]);
                    setSummary(sum);
                    setLinks(lks);
                    setArticleHTML(html);
                    setCurrentTitle(sum?.title || title);
                    if (pushHistory) setHistory((h) => [...h, sum?.title || title]);
                } catch (e) {
                    setError("Couldn't load the page. Try another link.");
                } finally {
                    setLoading(false);
                }
            }

            const handleLinkClick = (title) => {
                loadPage(title);
            };

            // Filter links based on search query
            const filteredLinks = useMemo(() => {
                if (!searchQuery.trim()) return links;
                const query = searchQuery.toLowerCase();
                return links.filter(link => link.toLowerCase().includes(query));
            }, [links, searchQuery]);

            async function navigateToStep(stepIndex) {
                if (stepIndex < 0 || stepIndex >= history.length) return;
                const targetTitle = history[stepIndex];
                await loadPage(targetTitle, true);
            }

            async function goBack() {
                if (history.length <= 1) return;
                const previousIndex = history.length - 2;
                const targetTitle = history[previousIndex];
                setHistory((h) => h.slice(0, previousIndex + 1));
                await loadPage(targetTitle, false);
            }

            async function startGame() {
                setWon(false);
                setHistory([]);
                setSummary(null);
                setLinks([]);
                setError("");
                setGameActive(false);
                setShowArticleOnMobile(false);
                setSetupCollapsed(true);

                try {
                    let s, g;
                    
                    if (dailyChallenge) {
                        // Daily Challenge mode: use date-based deterministic selection
                        const dailyArticles = await fetchDailyChallengeArticles();
                        s = dailyArticles.startTitle;
                        g = dailyArticles.goalTitle;
                        setStartTitle(s);
                        setGoalTitle(g);
                        setStartCategory("");
                        setGoalCategory("");
                    } else {
                        // Normal mode: use user selections or random
                        s = startTitle;
                        if (!s) {
                            if (startCategory) {
                                s = await fetchRandomTitleFromCategory(startCategory);
                            } else {
                                s = await fetchRandomTitle();
                            }
                        }
                        
                        g = goalTitle;
                        if (!g) {
                            if (goalCategory) {
                                g = await fetchRandomTitleFromCategory(goalCategory);
                            } else {
                                g = await fetchRandomTitle();
                            }
                        }
                        
                        setStartTitle(s);
                        setGoalTitle(g);
                    }
                    
                    // Fetch goal summary immediately when starting with random titles
                    if (g) {
                        fetchSummary(g).then(setGoalSummary).catch(() => setGoalSummary(null));
                    }
                    setGameActive(true);
                    await loadPage(s);
                } catch (e) {
                    setError("Failed to start game. Try again.");
                }
            }

            function resetGame() {
                if (!dailyChallenge) {
                    setStartTitle("");
                    setGoalTitle("");
                    setStartCategory("");
                    setGoalCategory("");
                }
                setStartSummary(null);
                setGoalSummary(null);
                setCurrentTitle(null);
                setSummary(null);
                setArticleHTML(null);
                setLinks([]);
                setHistory([]);
                setGameActive(false);
                setWon(false);
                setError("");
                setLoadingStartRandom(false);
                setLoadingGoalRandom(false);
                setShowArticleOnMobile(false);
                setSetupCollapsed(false);
            }

            useEffect(() => {
                if (currentTitle && goalTitle && gameActive) {
                    const normalizedCurrent = currentTitle.trim().toLowerCase();
                    const normalizedGoal = goalTitle.trim().toLowerCase();
                    
                    if (normalizedCurrent === normalizedGoal) {
                        setWon(true);
                        setGameActive(false);
                    }
                }
            }, [currentTitle, goalTitle, gameActive]);

            useEffect(() => {
                if (startTitle && !gameActive) {
                    fetchSummary(startTitle).then(setStartSummary).catch(() => setStartSummary(null));
                } else if (!startTitle) {
                    setStartSummary(null);
                }
            }, [startTitle, gameActive]);

            useEffect(() => {
                if (goalTitle) {
                    // Fetch goal summary whenever goalTitle changes, regardless of gameActive state
                    fetchSummary(goalTitle).then(setGoalSummary).catch(() => setGoalSummary(null));
                } else {
                    setGoalSummary(null);
                }
            }, [goalTitle]);

            // Update time until reset for Daily Challenge
            useEffect(() => {
                if (!dailyChallenge) return;
                
                const interval = setInterval(() => {
                    setTimeUntilReset(getTimeUntilMidnight());
                }, 1000);
                
                return () => clearInterval(interval);
            }, [dailyChallenge]);
            
            // Load daily challenge articles when mode is enabled
            useEffect(() => {
                if (dailyChallenge && !gameActive && !startTitle && !goalTitle && !dailyChallengeLoadedRef.current) {
                    dailyChallengeLoadedRef.current = true;
                    fetchDailyChallengeArticles().then(({ startTitle, goalTitle }) => {
                        setStartTitle(startTitle);
                        setGoalTitle(goalTitle);
                    }).catch(() => {
                        setError("Failed to load daily challenge. Try again.");
                        dailyChallengeLoadedRef.current = false;
                    });
                }
                
                // Reset the ref when daily challenge is disabled
                if (!dailyChallenge) {
                    dailyChallengeLoadedRef.current = false;
                }
            }, [dailyChallenge, gameActive, startTitle, goalTitle]);

            const moveCount = history.length ? history.length - 1 : 0;
            const finalTime = useRef(0);
            const confettiTriggered = useRef(false);

            const finalScore = useMemo(() => {
                if (!won) return 0;
                const seconds = Math.floor(finalTime.current / 1000);
                return Math.max(0, 1000 - (10 * moveCount) - seconds);
            }, [won, moveCount]);

            useEffect(() => {
                if (won && !confettiTriggered.current) {
                    confettiTriggered.current = true;
                    finalTime.current = timer;
                    
                    const duration = 3000;
                    const animationEnd = Date.now() + duration;
                    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                    function randomInRange(min, max) {
                        return Math.random() * (max - min) + min;
                    }

                    const interval = setInterval(function() {
                        const timeLeft = animationEnd - Date.now();

                        if (timeLeft <= 0) {
                            return clearInterval(interval);
                        }

                        const particleCount = 50 * (timeLeft / duration);
                        confetti({
                            ...defaults,
                            particleCount,
                            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
                        });
                        confetti({
                            ...defaults,
                            particleCount,
                            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
                        });
                    }, 250);

                    return () => {
                        clearInterval(interval);
                    };
                }
            }, [won, timer]);

            useEffect(() => {
                if (!won) {
                    confettiTriggered.current = false;
                    finalTime.current = 0;
                }
            }, [won]);

            return (
                <div className={`min-h-screen w-full p-2 sm:p-4 md:p-8 ${
                    theme === 'dark' 
                        ? 'bg-gray-950' 
                        : theme === 'classic'
                        ? 'bg-white'
                        : 'bg-gradient-to-b from-slate-50 to-white'
                }`}>
                    <div className="mx-auto max-w-[100%] sm:max-w-[95%] 2xl:max-w-[1600px] space-y-3 sm:space-y-4 lg:space-y-6">
                        <header className="flex flex-col gap-2 sm:gap-3 md:flex-row md:items-end md:justify-between">
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2 flex-wrap">
                                    <h1 className={`text-2xl sm:text-3xl md:text-4xl font-bold tracking-tight flex items-center gap-1.5 sm:gap-2 ${
                                        theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-slate-900 font-serif' : 'text-slate-900'
                                    }`}>
                                        <Compass className="h-6 w-6 sm:h-7 sm:w-7 md:h-8 md:w-8" /> WikiGo
                                    </h1>
                                    {dailyChallenge && (
                                        <Badge variant="default" className="flex items-center gap-1 text-xs sm:text-sm">
                                            <Calendar className="h-3 w-3" />
                                            <span className="hidden xs:inline">Daily Challenge</span>
                                            <span className="xs:hidden">Daily</span>
                                        </Badge>
                                    )}
                                </div>
                                <p className={`mt-1 text-xs sm:text-sm md:text-base ${
                                    theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-600'
                                }`}>
                                    Navigate from a start article to a goal article using only in-article links. Fewest moves, fastest time wins.
                                </p>
                                {dailyChallenge && (
                                    <p className={`text-xs mt-1 sm:mt-2 ${
                                        theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                    }`}>
                                        Challenge resets in: {prettyTime(timeUntilReset)}
                                    </p>
                                )}
                            </div>
                            <div className="flex gap-1.5 sm:gap-2 items-center flex-wrap">
                                <Button
                                    variant={dailyChallenge ? "default" : "outline"}
                                    onClick={() => {
                                        setDailyChallenge(!dailyChallenge);
                                        if (!dailyChallenge) {
                                            // Switching to Daily Challenge - reset articles
                                            setStartTitle("");
                                            setGoalTitle("");
                                            setStartCategory("");
                                            setGoalCategory("");
                                        }
                                    }}
                                    className="flex items-center gap-1.5 sm:gap-2 text-xs sm:text-sm h-9 sm:h-10 px-2 sm:px-4 min-w-[44px] sm:min-w-0"
                                >
                                    <Calendar className="h-3.5 w-3.5 sm:h-4 sm:w-4" />
                                    <span className="hidden sm:inline">Daily Challenge</span>
                                    <span className="sm:hidden">Daily</span>
                                </Button>
                                <ThemeSwitcher />
                                <Button 
                                    variant="secondary" 
                                    onClick={resetGame}
                                    className="text-xs sm:text-sm h-9 sm:h-10 px-2 sm:px-4 min-w-[44px] sm:min-w-0"
                                >
                                    Reset
                                </Button>
                                <Button 
                                    onClick={startGame}
                                    className="text-xs sm:text-sm h-9 sm:h-10 px-3 sm:px-4 min-w-[44px] sm:min-w-0"
                                >
                                    Start
                                </Button>
                            </div>
                        </header>

                        <Card className="shadow-sm">
                            <CardHeader className="p-3 sm:p-6">
                                <div className="flex items-center justify-between">
                                    <CardTitle className="text-base sm:text-lg">
                                        {dailyChallenge ? "Daily Challenge" : "Setup"}
                                    </CardTitle>
                                    {gameActive && (
                                        <Button
                                            variant="ghost"
                                            size="icon"
                                            onClick={() => setSetupCollapsed(!setupCollapsed)}
                                            className="h-8 w-8 sm:h-9 sm:w-9 min-w-[32px] sm:min-w-[36px]"
                                            title={setupCollapsed ? "Expand setup" : "Collapse setup"}
                                        >
                                            {setupCollapsed ? (
                                                <ChevronDown className="h-4 w-4" />
                                            ) : (
                                                <ChevronUp className="h-4 w-4" />
                                            )}
                                        </Button>
                                    )}
                                </div>
                            </CardHeader>
                            {(!gameActive || !setupCollapsed) && (
                            <CardContent className="space-y-4 sm:space-y-6 p-3 sm:p-6">
                                {dailyChallenge ? (
                                    <div className={`p-3 sm:p-4 rounded-lg border ${
                                        theme === 'dark'
                                            ? 'border-gray-700 bg-gray-800/50'
                                            : theme === 'classic'
                                            ? 'border-blue-600 bg-blue-50'
                                            : 'border-blue-200 bg-blue-50'
                                    }`}>
                                        <p className={`text-xs sm:text-sm ${
                                            theme === 'dark' ? 'text-gray-200' : 'text-slate-700'
                                        }`}>
                                            Today's challenge uses fixed start and goal articles that are the same for everyone. 
                                            Try to complete it in as few moves as possible!
                                        </p>
                                        {startTitle && goalTitle && (
                                            <div className="mt-3 sm:mt-4 space-y-1.5 sm:space-y-2">
                                                <div className={`text-xs sm:text-sm font-semibold break-words ${
                                                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                                                }`}>
                                                    Start: {startTitle}
                                                </div>
                                                <div className={`text-xs sm:text-sm font-semibold break-words ${
                                                    theme === 'dark' ? 'text-white' : 'text-slate-900'
                                                }`}>
                                                    Goal: {goalTitle}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                                    <div className="space-y-2">
                                        <label className={`text-xs sm:text-sm ${
                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700 font-semibold' : 'text-slate-600'
                                        }`}>
                                            Start article
                                        </label>
                                        <div className="space-y-2">
                                            <select
                                                value={startCategory}
                                                onChange={(e) => setStartCategory(e.target.value)}
                                                className={`flex h-10 sm:h-11 w-full rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-200 classic:ring-offset-white classic:focus-visible:ring-blue-600 classic:border-slate-400 classic:bg-white classic:text-slate-900 ${
                                                    theme === 'dark'
                                                        ? "border-gray-800 bg-gray-900"
                                                        : theme === 'classic'
                                                        ? "border-slate-400 bg-white"
                                                        : "border-slate-200 bg-white"
                                                }`}
                                                disabled={gameActive || dailyChallenge}
                                            >
                                                {CATEGORIES.map((cat) => (
                                                    <option key={cat.value} value={cat.value}>
                                                        {cat.label}
                                                    </option>
                                                ))}
                                            </select>
                                            <div className="flex gap-1.5 sm:gap-2">
                                                <Input 
                                                    placeholder="e.g., Alan Turing" 
                                                    value={startTitle} 
                                                    onChange={(e) => setStartTitle(e.target.value)}
                                                    disabled={gameActive || dailyChallenge}
                                                    className="h-10 sm:h-11 text-sm flex-1 min-w-0"
                                                />
                                                <Button 
                                                    variant="outline" 
                                                    onClick={async () => {
                                                        if (loadingStartRandom || dailyChallenge) return;
                                                        setError("");
                                                        setLoadingStartRandom(true);
                                                        try {
                                                            const title = startCategory 
                                                                ? await fetchRandomTitleFromCategory(startCategory)
                                                                : await fetchRandomTitle();
                                                            if (title) {
                                                                setStartTitle(title);
                                                            } else {
                                                                setError("Could not fetch random article. Try again or select a different category.");
                                                            }
                                                        } catch (e) {
                                                            setError("Failed to fetch random article. Please try again.");
                                                        } finally {
                                                            setLoadingStartRandom(false);
                                                        }
                                                    }}
                                                    disabled={gameActive || loadingStartRandom || dailyChallenge}
                                                    className="h-10 sm:h-11 min-w-[44px] sm:min-w-[48px] px-2 sm:px-3 flex-shrink-0"
                                                >
                                                    {loadingStartRandom ? (
                                                        <Loader2 className="h-4 w-4 animate-spin" />
                                                    ) : (
                                                        <Shuffle className="h-4 w-4" />
                                                    )}
                                                </Button>
                                            </div>
                                        </div>
                                        {startSummary && !gameActive && (
                                            <div className={`mt-3 p-3 rounded-lg border space-y-2 ${
                                                theme === 'dark'
                                                    ? 'border-gray-800 bg-gray-900'
                                                    : theme === 'classic'
                                                    ? 'border-slate-400 bg-slate-50'
                                                    : 'border-slate-200 bg-slate-50'
                                            }`}>
                                                <div className="flex gap-3">
                                                    {startSummary.thumbnail && (
                                                        <img src={startSummary.thumbnail} alt={startSummary.title} className="h-16 w-16 rounded-lg object-cover flex-shrink-0" />
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <div className={`font-semibold text-sm ${
                                                            theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            {startSummary.title}
                                                        </div>
                                                        {startSummary.description && (
                                                            <div className={`text-xs mt-1 ${
                                                                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                            }`}>
                                                                {startSummary.description}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                {startSummary.extract && (
                                                    <p className={`text-xs line-clamp-3 ${
                                                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                    }`}>
                                                        {startSummary.extract}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    <div className="space-y-2">
                                        <label className={`text-xs sm:text-sm ${
                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700 font-semibold' : 'text-slate-600'
                                        }`}>
                                            Goal article
                                        </label>
                                        <div className="space-y-2">
                                            <select
                                                value={goalCategory}
                                                onChange={(e) => setGoalCategory(e.target.value)}
                                                className={`flex h-10 sm:h-11 w-full rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:ring-offset-gray-950 dark:focus-visible:ring-gray-400 dark:border-gray-800 dark:bg-gray-900 dark:text-gray-200 classic:ring-offset-white classic:focus-visible:ring-blue-600 classic:border-slate-400 classic:bg-white classic:text-slate-900 ${
                                                    theme === 'dark'
                                                        ? "border-gray-800 bg-gray-900"
                                                        : theme === 'classic'
                                                        ? "border-slate-400 bg-white"
                                                        : "border-slate-200 bg-white"
                                                }`}
                                                disabled={gameActive || dailyChallenge}
                                            >
                                                {CATEGORIES.map((cat) => (
                                                    <option key={cat.value} value={cat.value}>
                                                        {cat.label}
                                                    </option>
                                                ))}
                                            </select>
                                            <div className="flex gap-1.5 sm:gap-2">
                                                <Input 
                                                    placeholder="e.g., Black Hole" 
                                                    value={goalTitle} 
                                                    onChange={(e) => setGoalTitle(e.target.value)}
                                                    disabled={gameActive || dailyChallenge}
                                                    className="h-10 sm:h-11 text-sm flex-1 min-w-0"
                                                />
                                                <Button 
                                                    variant="outline" 
                                                    onClick={async () => {
                                                        if (loadingGoalRandom || dailyChallenge) return;
                                                        setError("");
                                                        setLoadingGoalRandom(true);
                                                        try {
                                                            const title = goalCategory 
                                                                ? await fetchRandomTitleFromCategory(goalCategory)
                                                                : await fetchRandomTitle();
                                                            if (title) {
                                                                setGoalTitle(title);
                                                            } else {
                                                                setError("Could not fetch random article. Try again or select a different category.");
                                                            }
                                                        } catch (e) {
                                                            setError("Failed to fetch random article. Please try again.");
                                                        } finally {
                                                            setLoadingGoalRandom(false);
                                                        }
                                                    }}
                                                    disabled={gameActive || loadingGoalRandom || dailyChallenge}
                                                    className="h-10 sm:h-11 min-w-[44px] sm:min-w-[48px] px-2 sm:px-3 flex-shrink-0"
                                                >
                                                    {loadingGoalRandom ? (
                                                        <Loader2 className="h-4 w-4 animate-spin" />
                                                    ) : (
                                                        <Flag className="h-4 w-4" />
                                                    )}
                                                </Button>
                                            </div>
                                        </div>
                                        {goalSummary && !gameActive && (
                                            <div className={`mt-3 p-3 rounded-lg border space-y-2 ${
                                                theme === 'dark'
                                                    ? 'border-gray-800 bg-gray-900'
                                                    : theme === 'classic'
                                                    ? 'border-slate-400 bg-slate-50'
                                                    : 'border-slate-200 bg-slate-50'
                                            }`}>
                                                <div className="flex gap-3">
                                                    {goalSummary.thumbnail && (
                                                        <img src={goalSummary.thumbnail} alt={goalSummary.title} className="h-16 w-16 rounded-lg object-cover flex-shrink-0" />
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <div className={`font-semibold text-sm ${
                                                            theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            {goalSummary.title}
                                                        </div>
                                                        {goalSummary.description && (
                                                            <div className={`text-xs mt-1 ${
                                                                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                            }`}>
                                                                {goalSummary.description}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                {goalSummary.extract && (
                                                    <p className={`text-xs line-clamp-3 ${
                                                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                    }`}>
                                                        {goalSummary.extract}
                                                    </p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                )}
                            </CardContent>
                            )}
                        </Card>

                        {gameActive && articleHTML ? (
                            <div className="flex flex-col lg:grid lg:grid-cols-[2fr,1.2fr,1fr] xl:grid-cols-[2.5fr,1.2fr,1fr] gap-3 sm:gap-4 lg:gap-4">
                                {/* Left column: Full Wikipedia Article - Hidden on mobile by default */}
                                <div className={`space-y-3 sm:space-y-4 lg:space-y-4 order-6 lg:order-1 ${showArticleOnMobile ? 'block' : 'hidden'} lg:block`}>
                                    <Card className="shadow-sm lg:sticky lg:top-4">
                                        <CardHeader className="p-3 sm:p-4 lg:p-4">
                                            <div className="flex items-center justify-between">
                                                <CardTitle className="flex items-center gap-2 text-base sm:text-lg">
                                                    <Compass className="h-4 w-4 sm:h-5 sm:w-5" />
                                                    <span className="break-words">{summary?.title || currentTitle}</span>
                                                </CardTitle>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    onClick={() => setShowArticleOnMobile(false)}
                                                    className="lg:hidden h-8 w-8 sm:h-9 sm:w-9 min-w-[32px] sm:min-w-[36px]"
                                                    title="Hide article"
                                                >
                                                    <EyeOff className="h-4 w-4" />
                                                </Button>
                                            </div>
                                        </CardHeader>
                                        <CardContent className="p-0">
                                            <WikipediaArticleViewer 
                                                html={articleHTML} 
                                                onLinkClick={handleLinkClick}
                                                theme={theme}
                                            />
                                        </CardContent>
                                    </Card>
                                </div>

                                {/* Toggle button to show article on mobile - Only visible when article is hidden */}
                                {!showArticleOnMobile && (
                                    <div className="order-6 lg:hidden">
                                        <Button
                                            variant="outline"
                                            onClick={() => setShowArticleOnMobile(true)}
                                            className="w-full h-10 sm:h-11 flex items-center justify-center gap-2"
                                        >
                                            <Eye className="h-4 w-4" />
                                            <span>Show Wikipedia Article</span>
                                        </Button>
                                    </div>
                                )}

                                {/* Middle column: Game Controls */}
                                <div className="space-y-3 sm:space-y-4 lg:space-y-4 order-4 lg:order-2">
                                    <Card className="shadow-sm">
                                        <CardHeader className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0 p-3 sm:p-4 lg:p-4">
                                            <div className="flex items-center gap-2 sm:gap-3 flex-1 min-w-0">
                                                {gameActive && history.length > 1 && (
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        onClick={goBack}
                                                        className="flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10 min-w-[36px] sm:min-w-[40px]"
                                                        title="Go back to previous page"
                                                    >
                                                        <ArrowLeft className="h-4 w-4" />
                                                    </Button>
                                                )}
                                                <CardTitle className="flex items-center gap-1.5 sm:gap-2 text-sm sm:text-base flex-1 min-w-0">
                                                    <Target className="h-4 w-4 sm:h-5 sm:w-5 flex-shrink-0" /> 
                                                    <span className="truncate">{goalTitle ? `Goal: ${goalTitle}` : "Pick a goal and start"}</span>
                                                </CardTitle>
                                            </div>
                                            <div className="flex items-center gap-2 sm:gap-3 w-full sm:w-auto">
                                                <Badge variant={won ? "default" : "secondary"} className="text-xs">
                                                    {won ? "Completed" : gameActive ? "In progress" : "Idle"}
                                                </Badge>
                                                <div className={`flex items-center gap-1 text-xs sm:text-sm ${
                                                    theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-600'
                                                }`}>
                                                    <Timer className="h-3.5 w-3.5 sm:h-4 sm:w-4" /> {prettyTime(timer)}
                                                </div>
                                            </div>
                                        </CardHeader>
                                        <CardContent className="p-3 sm:p-4 lg:p-4">
                                            {error && (
                                            <div className={`mb-4 rounded-xl border p-3 text-sm ${
                                                theme === 'dark'
                                                    ? 'border-red-800 bg-red-900/30 text-red-300'
                                                    : theme === 'classic'
                                                    ? 'border-red-600 bg-red-50 text-red-800'
                                                    : 'border-red-200 bg-red-50 text-red-700'
                                            }`}>
                                                {error}
                                            </div>
                                        )}

                                            {summary && (
                                                <div className="space-y-3 sm:space-y-4">
                                                    <div className="flex gap-2 sm:gap-4">
                                                        {summary.thumbnail && (
                                                            <img src={summary.thumbnail} alt={summary.title} className="h-16 w-16 sm:h-20 sm:w-20 rounded-lg object-cover flex-shrink-0" />
                                                        )}
                                                        <div className="flex-1 min-w-0">
                                                            <div className={`font-semibold text-sm sm:text-base break-words ${
                                                                theme === 'dark' ? 'text-white' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                            }`}>
                                                                {summary.title}
                                                            </div>
                                                            {summary.description && (
                                                                <div className={`text-xs sm:text-sm mt-1 ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                                }`}>
                                                                    {summary.description}
                                                                </div>
                                                            )}
                                                            <a 
                                                                className={`text-xs sm:text-sm underline mt-1 inline-block ${
                                                                    theme === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'
                                                                }`} 
                                                                href={summary.url} 
                                                                target="_blank" 
                                                                rel="noreferrer"
                                                            >
                                                                Open on Wikipedia
                                                            </a>
                                                        </div>
                                                    </div>
                                                    {summary.extract && (
                                                        <p className={`leading-relaxed text-xs sm:text-sm ${
                                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                        }`}>
                                                            {summary.extract}
                                                        </p>
                                                    )}
                                                    <div className="space-y-2">
                                                        <div className="flex items-center gap-2 sm:gap-3">
                                                            <span className={`text-xs sm:text-sm font-medium ${
                                                                theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                            }`}>Progress to goal</span>
                                                            <span className={`text-xs ${
                                                                theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-slate-500' : 'text-slate-500'
                                                            }`}>(toy similarity)</span>
                                                        </div>
                                                        <Progress value={progress} />
                                                        <div className={`text-xs ${
                                                            theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-slate-500' : 'text-slate-500'
                                                        }`}>{progress}%</div>
                                                    </div>

                                                    <div className="mt-4 sm:mt-6">
                                                        <div className={`mb-2 text-xs sm:text-sm font-semibold flex items-center justify-between ${
                                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            Search links
                                                        </div>
                                                        <div className="flex gap-1.5 sm:gap-2 mb-3 sm:mb-4">
                                                            <Input
                                                                type="text"
                                                                placeholder="Filter links..."
                                                                value={searchQuery}
                                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                                className={`flex-1 h-9 sm:h-10 text-sm ${
                                                                    theme === 'dark'
                                                                        ? 'bg-gray-900 border-gray-800 text-gray-200 placeholder:text-gray-400'
                                                                        : theme === 'classic'
                                                                        ? 'bg-white border-slate-300 text-slate-900'
                                                                        : 'bg-white border-slate-300 text-slate-900'
                                                                }`}
                                                            />
                                                            {searchQuery && (
                                                                <Button
                                                                    variant="outline"
                                                                    onClick={() => setSearchQuery("")}
                                                                    className="flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10 min-w-[36px] sm:min-w-[40px] p-0"
                                                                >
                                                                    <X className="h-4 w-4" />
                                                                </Button>
                                                            )}
                                                        </div>
                                                        <div className={`mb-2 text-xs sm:text-sm font-semibold flex items-center justify-between ${
                                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            <span className="truncate">Available links {filteredLinks.length !== links.length && `(${filteredLinks.length}/${links.length})`}</span>
                                                        </div>
                                                        <div className="grid grid-cols-1 gap-1.5 sm:gap-2 max-h-[300px] sm:max-h-[400px] overflow-y-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                                                            {loading && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    Loading links
                                                                </div>
                                                            )}
                                                            {!loading && links.length === 0 && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    No links found on this page.
                                                                </div>
                                                            )}
                                                            {!loading && links.length > 0 && filteredLinks.length === 0 && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    No links match your search.
                                                                </div>
                                                            )}
                                                            {!loading &&
                                                                filteredLinks.map((l) => (
                                                                    <Button 
                                                                        key={l} 
                                                                        variant="outline" 
                                                                        className="justify-start text-left h-auto min-h-[44px] py-2 px-3 text-xs sm:text-sm break-words whitespace-normal" 
                                                                        onClick={() => loadPage(l)}
                                                                    >
                                                                        {l}
                                                                    </Button>
                                                                ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </CardContent>
                                    </Card>
                                </div>

                                {/* Right column: Goal Summary, Steps, Scoring */}
                                <div className="flex flex-col gap-3 sm:gap-4 lg:gap-4 order-1 lg:order-3">
                                {gameActive && goalSummary && (
                                    <Card className={`shadow-sm border-2 ${
                                        theme === 'dark'
                                            ? 'border-gray-700 bg-gray-800/50'
                                            : theme === 'classic'
                                            ? 'border-blue-600 bg-blue-50'
                                            : 'border-blue-200 bg-blue-50/50'
                                    }`}>
                                        <CardHeader>
                                            <CardTitle className="flex items-center gap-2">
                                                <Flag className={`h-5 w-5 ${
                                                    theme === 'dark' ? 'text-gray-300' : 'text-blue-600'
                                                }`} />
                                                <span className={theme === 'dark' ? 'text-gray-200' : 'text-blue-900'}>Goal Article</span>
                                            </CardTitle>
                                        </CardHeader>
                                        <CardContent className="space-y-3">
                                            <div className="flex gap-3">
                                                {goalSummary.thumbnail && (
                                                    <img src={goalSummary.thumbnail} alt={goalSummary.title} className="h-20 w-20 rounded-lg object-cover flex-shrink-0" />
                                                )}
                                                <div className="flex-1 min-w-0">
                                                    <div className={`font-semibold ${
                                                        theme === 'dark' ? 'text-white' : 'text-slate-900'
                                                    }`}>{goalSummary.title}</div>
                                                    {goalSummary.description && (
                                                        <div className={`text-sm mt-1 ${
                                                            theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                        }`}>{goalSummary.description}</div>
                                                    )}
                                                </div>
                                            </div>
                                            {goalSummary.extract && (
                                                <p className={`text-sm leading-relaxed line-clamp-4 ${
                                                    theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                }`}>{goalSummary.extract}</p>
                                            )}
                                            <a 
                                                className={`text-sm underline inline-block ${
                                                    theme === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'
                                                }`} 
                                                href={goalSummary.url} 
                                                target="_blank" 
                                                rel="noreferrer"
                                            >
                                                Open on Wikipedia 
                                            </a>
                                        </CardContent>
                                    </Card>
                                )}

                                {gameActive && history.length > 0 && (
                                    <Card className="shadow-sm">
                                        <CardHeader>
                                            <CardTitle className="flex items-center gap-2">
                                                <History className="h-5 w-5" />
                                                Steps Taken ({moveCount})
                                            </CardTitle>
                                        </CardHeader>
                                        <CardContent>
                                            <div className="space-y-2">
                                                {history.map((article, index) => (
                                                    <button
                                                        key={index}
                                                        onClick={() => navigateToStep(index)}
                                                        className="w-full flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-200 transition-colors cursor-pointer text-left"
                                                    >
                                                        <div className="flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold text-slate-700">
                                                            {index + 1}
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="font-medium text-slate-900">{article}</div>
                                                            {index === 0 && <div className="text-xs text-slate-500 mt-1">Start</div>}
                                                            {index === history.length - 1 && <div className="text-xs text-green-600 mt-1 font-semibold">Current</div>}
                                                        </div>
                                                        {index < history.length - 1 && (
                                                            <div className="text-slate-400">
                                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                                </svg>
                                                            </div>
                                                        )}
                                                    </button>
                                                ))}
                                            </div>
                                        </CardContent>
                                    </Card>
                                )}

                                <Card className="shadow-sm">
                                    <CardHeader>
                                        <CardTitle className="flex items-center gap-2"><Trophy className="h-5 w-5" /> Scoring</CardTitle>
                                    </CardHeader>
                                    <CardContent className={`text-sm space-y-2 ${
                                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                    }`}>
                                        <p> Base score: 1000  (10  moves)  (1  seconds).</p>
                                        <p> Beat your personal best by reaching the goal with fewer moves and in less time.</p>
                                        <p>Tip: Use link structure intuitionjump to broad categories, then narrow in.</p>
                                    </CardContent>
                                </Card>
                                </div>
                            </div>
                        ) : (
                            <div className="grid md:grid-cols-[1.4fr,1fr] gap-6">
                                <div className="space-y-6">
                                    <Card className="shadow-sm">
                                        <CardHeader className="flex flex-row items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                {gameActive && history.length > 1 && (
                                                    <Button
                                                        variant="outline"
                                                        size="icon"
                                                        onClick={goBack}
                                                        className="flex-shrink-0"
                                                        title="Go back to previous page"
                                                    >
                                                        <ArrowLeft className="h-4 w-4" />
                                                    </Button>
                                                )}
                                                <CardTitle className="flex items-center gap-2">
                                                    <Target className="h-5 w-5" /> {goalTitle ? `Goal: ${goalTitle}` : "Pick a goal and start"}
                                                </CardTitle>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <Badge variant={won ? "default" : "secondary"} className="text-xs">
                                                    {won ? "Completed" : gameActive ? "In progress" : "Idle"}
                                                </Badge>
                                                <div className={`flex items-center gap-1 text-sm ${
                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                }`}>
                                                    <Timer className="h-4 w-4" /> {prettyTime(timer)}
                                                </div>
                                            </div>
                                        </CardHeader>
                                        <CardContent>
                                            {error && (
                                                <div className={`mb-4 rounded-xl border p-3 text-sm ${
                                                    theme === 'dark'
                                                        ? 'border-red-800 bg-red-900/30 text-red-300'
                                                        : theme === 'classic'
                                                        ? 'border-red-600 bg-red-50 text-red-800'
                                                        : 'border-red-200 bg-red-50 text-red-700'
                                                }`}>
                                                    {error}
                                                </div>
                                            )}

                                            {summary ? (
                                                <div className="space-y-4">
                                                    <div className="flex gap-4">
                                                        {summary.thumbnail && (
                                                            <img src={summary.thumbnail} alt={summary.title} className="h-20 w-20 rounded-xl object-cover" />
                                                        )}
                                                        <div>
                                                            <div className={`text-xl font-semibold ${
                                                                theme === 'dark' ? 'text-white' : 'text-slate-900'
                                                            }`}>{summary.title}</div>
                                                            <div className={`text-sm ${
                                                                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                            }`}>{summary.description}</div>
                                                            <a className={`text-sm underline ${
                                                                theme === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'
                                                            }`} href={summary.url} target="_blank" rel="noreferrer">Open on Wikipedia</a>
                                                        </div>
                                                    </div>
                                                    <p className={`leading-relaxed ${
                                                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                    }`}>{summary.extract}</p>
                                                    <div className="space-y-2">
                                                        <div className="flex items-center gap-3">
                                                            <span className={`text-sm font-medium ${
                                                                theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                            }`}>Progress to goal</span>
                                                            <span className={`text-xs ${
                                                                theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-slate-500' : 'text-slate-500'
                                                            }`}>(toy similarity)</span>
                                                        </div>
                                                        <Progress value={progress} />
                                                        <div className={`text-xs ${
                                                            theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-slate-500' : 'text-slate-500'
                                                        }`}>{progress}%</div>
                                                    </div>

                                                    <div className="mt-6">
                                                        <div className={`mb-2 text-sm font-semibold flex items-center justify-between ${
                                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            Search links
                                                        </div>
                                                        <div className="flex gap-1.5 sm:gap-2 mb-4">
                                                            <Input
                                                                type="text"
                                                                placeholder="Filter links..."
                                                                value={searchQuery}
                                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                                className={`flex-1 h-9 sm:h-10 text-sm ${
                                                                    theme === 'dark'
                                                                        ? 'bg-gray-900 border-gray-800 text-gray-200 placeholder:text-gray-400'
                                                                        : theme === 'classic'
                                                                        ? 'bg-white border-slate-300 text-slate-900'
                                                                        : 'bg-white border-slate-300 text-slate-900'
                                                                }`}
                                                            />
                                                            {searchQuery && (
                                                                <Button
                                                                    variant="outline"
                                                                    onClick={() => setSearchQuery("")}
                                                                    className="flex-shrink-0 h-9 w-9 sm:h-10 sm:w-10 min-w-[36px] sm:min-w-[40px] p-0"
                                                                >
                                                                    <X className="h-4 w-4" />
                                                                </Button>
                                                            )}
                                                        </div>
                                                        <div className={`mb-2 text-xs sm:text-sm font-semibold flex items-center justify-between ${
                                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-900' : 'text-slate-900'
                                                        }`}>
                                                            <span className="truncate">Available links {filteredLinks.length !== links.length && `(${filteredLinks.length}/${links.length})`}</span>
                                                        </div>
                                                        <div className="grid grid-cols-1 gap-1.5 sm:gap-2 max-h-[300px] sm:max-h-[400px] overflow-y-auto" style={{ WebkitOverflowScrolling: 'touch' }}>
                                                            {loading && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    Loading links
                                                                </div>
                                                            )}
                                                            {!loading && links.length === 0 && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    No links found on this page.
                                                                </div>
                                                            )}
                                                            {!loading && links.length > 0 && filteredLinks.length === 0 && (
                                                                <div className={`text-xs sm:text-sm ${
                                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-500'
                                                                }`}>
                                                                    No links match your search.
                                                                </div>
                                                            )}
                                                            {!loading &&
                                                                filteredLinks.map((l) => (
                                                                    <Button 
                                                                        key={l} 
                                                                        variant="outline" 
                                                                        className="justify-start text-left h-auto min-h-[44px] py-2 px-3 text-xs sm:text-sm break-words whitespace-normal" 
                                                                        onClick={() => loadPage(l)}
                                                                    >
                                                                        {l}
                                                                    </Button>
                                                                ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className={`text-sm ${
                                                    theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                }`}>
                                                    Click <span className="font-medium">Start</span> to randomize (or use your own) start/goal and begin the journey.
                                                </div>
                                            )}
                                        </CardContent>
                                    </Card>
                                </div>

                                <div className="space-y-6">
                                    {gameActive && goalSummary && (
                                        <Card className={`shadow-sm border-2 ${
                                            theme === 'dark'
                                                ? 'border-gray-700 bg-gray-800/50'
                                                : theme === 'classic'
                                                ? 'border-blue-600 bg-blue-50'
                                                : 'border-blue-200 bg-blue-50/50'
                                        }`}>
                                            <CardHeader>
                                                <CardTitle className="flex items-center gap-2">
                                                    <Flag className={`h-5 w-5 ${
                                                        theme === 'dark' ? 'text-gray-300' : 'text-blue-600'
                                                    }`} />
                                                    <span className={theme === 'dark' ? 'text-gray-200' : 'text-blue-900'}>Goal Article</span>
                                                </CardTitle>
                                            </CardHeader>
                                            <CardContent className="space-y-3">
                                                <div className="flex gap-3">
                                                    {goalSummary.thumbnail && (
                                                        <img src={goalSummary.thumbnail} alt={goalSummary.title} className="h-20 w-20 rounded-lg object-cover flex-shrink-0" />
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <div className={`font-semibold ${
                                                            theme === 'dark' ? 'text-white' : 'text-slate-900'
                                                        }`}>{goalSummary.title}</div>
                                                        {goalSummary.description && (
                                                            <div className={`text-sm mt-1 ${
                                                                theme === 'dark' ? 'text-gray-300' : theme === 'classic' ? 'text-slate-600' : 'text-slate-600'
                                                            }`}>{goalSummary.description}</div>
                                                        )}
                                                    </div>
                                                </div>
                                                {goalSummary.extract && (
                                                    <p className={`text-sm leading-relaxed line-clamp-4 ${
                                                        theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                                    }`}>{goalSummary.extract}</p>
                                                )}
                                                <a 
                                                    className={`text-sm underline inline-block ${
                                                        theme === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'
                                                    }`} 
                                                    href={goalSummary.url} 
                                                    target="_blank" 
                                                    rel="noreferrer"
                                                >
                                                    Open on Wikipedia 
                                                </a>
                                            </CardContent>
                                        </Card>
                                    )}

                                    {gameActive && history.length > 0 && (
                                        <Card className="shadow-sm">
                                            <CardHeader>
                                                <CardTitle className="flex items-center gap-2">
                                                    <History className="h-5 w-5" />
                                                    Steps Taken ({moveCount})
                                                </CardTitle>
                                            </CardHeader>
                                            <CardContent>
                                                <div className="space-y-2">
                                                    {history.map((article, index) => (
                                                        <button
                                                            key={index}
                                                            onClick={() => navigateToStep(index)}
                                                            className="w-full flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-200 transition-colors cursor-pointer text-left"
                                                        >
                                                            <div className="flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold text-slate-700">
                                                                {index + 1}
                                                            </div>
                                                            <div className="flex-1">
                                                                <div className="font-medium text-slate-900">{article}</div>
                                                                {index === 0 && <div className="text-xs text-slate-500 mt-1">Start</div>}
                                                                {index === history.length - 1 && <div className="text-xs text-green-600 mt-1 font-semibold">Current</div>}
                                                            </div>
                                                            {index < history.length - 1 && (
                                                                <div className="text-slate-400">
                                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                                    </svg>
                                                                </div>
                                                            )}
                                                        </button>
                                                    ))}
                                                </div>
                                            </CardContent>
                                        </Card>
                                    )}

                                    <Card className="shadow-sm">
                                        <CardHeader>
                                            <CardTitle className="flex items-center gap-2"><Trophy className="h-5 w-5" /> Scoring</CardTitle>
                                        </CardHeader>
                                        <CardContent className={`text-sm space-y-2 ${
                                            theme === 'dark' ? 'text-gray-200' : theme === 'classic' ? 'text-slate-700' : 'text-slate-700'
                                        }`}>
                                            <p> Base score: 1000  (10  moves)  (1  seconds).</p>
                                            <p> Beat your personal best by reaching the goal with fewer moves and in less time.</p>
                                            <p>Tip: Use link structure intuitionjump to broad categories, then narrow in.</p>
                                        </CardContent>
                                    </Card>
                                </div>
                            </div>
                        )}

                        <footer className={`text-xs text-center pt-4 ${
                            theme === 'dark' ? 'text-gray-400' : theme === 'classic' ? 'text-slate-500' : 'text-slate-500'
                        }`}>
                            Uses the public Wikipedia API. Be kind to Wikimedia servers.
                        </footer>
                    </div>

                    {won && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
                                <CardHeader className="relative bg-gradient-to-r from-yellow-400 via-orange-400 to-pink-400 text-white">
                                    <div className="flex items-center justify-center gap-3">
                                        <Trophy className="h-8 w-8" />
                                        <CardTitle className="text-3xl">Congratulations!</CardTitle>
                                    </div>
                                    <p className="text-center mt-2 text-yellow-50">You've reached your destination!</p>
                                    <Button
                                        variant="ghost"
                                        size="icon"
                                        className="absolute top-4 right-4 text-white hover:bg-white/20"
                                        onClick={resetGame}
                                    >
                                        <X className="h-5 w-5" />
                                    </Button>
                                </CardHeader>
                                <CardContent className="p-6 space-y-6">
                                    <div className="grid grid-cols-3 gap-4">
                                        <div className="text-center p-4 rounded-lg bg-slate-50">
                                            <div className="text-3xl font-bold text-slate-900">{moveCount}</div>
                                            <div className="text-sm text-slate-600 mt-1">Moves</div>
                                        </div>
                                        <div className="text-center p-4 rounded-lg bg-slate-50">
                                            <div className="text-3xl font-bold text-slate-900">{prettyTime(finalTime.current)}</div>
                                            <div className="text-sm text-slate-600 mt-1">Time</div>
                                        </div>
                                        <div className="text-center p-4 rounded-lg bg-gradient-to-br from-yellow-100 to-orange-100 border-2 border-yellow-300">
                                            <div className="text-3xl font-bold text-slate-900">{finalScore}</div>
                                            <div className="text-sm text-slate-600 mt-1">Score</div>
                                        </div>
                                    </div>

                                    <div>
                                        <div className="flex items-center gap-2 mb-3">
                                            <History className="h-5 w-5 text-slate-600" />
                                            <h3 className="font-semibold text-lg">Your Journey</h3>
                                        </div>
                                        <div className="space-y-2">
                                            {history.map((article, index) => (
                                                <div key={index} className="flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition-colors">
                                                    <div className="flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm font-semibold text-slate-700">
                                                        {index + 1}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="font-medium text-slate-900">{article}</div>
                                                        {index === 0 && <div className="text-xs text-slate-500 mt-1">Start</div>}
                                                        {index === history.length - 1 && <div className="text-xs text-green-600 mt-1 font-semibold">Goal reached! </div>}
                                                    </div>
                                                    {index < history.length - 1 && (
                                                        <div className="text-slate-400">
                                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                                            </svg>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="p-4 rounded-lg bg-slate-50 border border-slate-200">
                                        <h3 className="font-semibold mb-3">Score Breakdown</h3>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Base score:</span>
                                                <span className="font-semibold">1000</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Moves penalty (10  {moveCount}):</span>
                                                <span className="font-semibold text-red-600">-{10 * moveCount}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-slate-600">Time penalty (1  {Math.floor(finalTime.current / 1000)}s):</span>
                                                <span className="font-semibold text-red-600">-{Math.floor(finalTime.current / 1000)}</span>
                                            </div>
                                            <div className="border-t border-slate-300 pt-2 mt-2 flex justify-between">
                                                <span className="font-semibold">Final Score:</span>
                                                <span className="font-bold text-lg text-slate-900">{finalScore}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex gap-3">
                                        <Button className="flex-1" onClick={resetGame}>
                                            Play Again
                                        </Button>
                                        <Button variant="outline" className="flex-1" onClick={() => {
                                            const text = `I completed the WikiGo challenge from "${startTitle}" to "${goalTitle}" in ${moveCount} moves and ${prettyTime(finalTime.current)}! Score: ${finalScore}`;
                                            if (navigator.share) {
                                                navigator.share({ text, title: "WikiGo" });
                                            } else {
                                                navigator.clipboard.writeText(text);
                                                alert("Results copied to clipboard!");
                                            }
                                        }}>
                                            Share Results
                                        </Button>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ThemeProvider>
                <WikipediaJourneyGame />
            </ThemeProvider>
        );
    </script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar {
            width: 10px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #030712;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 5px;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
</body>
</html>

